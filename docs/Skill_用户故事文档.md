# 技能系统用户故事文档

> 基于 mir2 项目代码分析生成
> 生成日期: 2026-01-30

---

## 目录

1. [技能系统概述](#技能系统概述)
2. [技能分类表](#技能分类表)
3. [Epic 级别用户故事](#epic-级别用户故事)
4. [具体用户故事](#具体用户故事)
5. [边界场景与异常处理](#边界场景与异常处理)
6. [技术架构总结](#技术架构总结)

---

## 技能系统概述

### 核心文件结构

| 文件路径 | 功能描述 |
|---------|---------|
| `Source/M2Server/Magic.pas` | 服务器端技能管理器 - 处理所有技能施放逻辑 |
| `Source/Common/Grobal2.pas` | 全局数据结构定义 - 技能数据类型定义 |
| `Source/M2Server/ObjBase.pas` | 生物对象基类 - 技能施放方法实现 |
| `Source/Client/magiceff.pas` | 客户端技能效果 - 技能视觉效果处理 |

### 技能数据结构

**TDefMagic** (`Grobal2.pas:590-613`) - 技能定义结构:
- `MagicId`: 技能唯一标识
- `Spell`: 魔法消耗
- `MinPower/MaxPower`: 威力范围
- `NeedLevel[0..3]`: 各等级需求角色等级
- `MaxTrain[0..3]`: 各等级最大修炼值
- `Job`: 职业限制 (0=战士, 1=法师, 2=道士, 99=通用)
- `DelayTime`: 冷却时间(毫秒)

**TUserMagic** (`Grobal2.pas:616-626`) - 用户技能结构:
- `Level`: 当前技能等级 (0-3)
- `Key`: 快捷键
- `CurTrain`: 当前修炼值

---

## 技能分类表

### 按职业分类

| 职业 | 技能ID | 技能名称 | 类型 |
|------|--------|---------|------|
| **战士** | 3 | 攻杀剑术 | 剑术 |
| **战士** | 4 | 刺杀剑术 | 剑术 |
| **战士** | 7 | 半月弯刀 | 剑术 |
| **战士** | 8 | 抱月刃 | 推开 |
| **战士** | 12 | 烈火剑法 | 剑术 |
| **战士** | 25 | 莲月剑法 | 剑术 |
| **战士** | 26 | 开天斩 | 剑术 |
| **战士** | 27 | 逐日剑法 | 剑术 |
| **战士** | 37 | 野蛮冲撞 | 推开 |
| **法师** | 1 | 火球术 | 单体攻击 |
| **法师** | 5 | 大火球 | 单体攻击 |
| **法师** | 9 | 地狱火 | 穿透攻击 |
| **法师** | 10 | 雷电术 | 穿透攻击 |
| **法师** | 11 | 灵魂火符 | 单体攻击 |
| **法师** | 22 | 火墙 | 场景技能 |
| **法师** | 23 | 爆裂火焰 | 范围攻击 |
| **法师** | 24 | 地狱雷光 | 范围攻击 |
| **法师** | 31 | 魔法盾 | 防御 |
| **道士** | 2 | 治愈术 | 治疗 |
| **道士** | 6 | 施毒术 | 毒系 |
| **道士** | 13 | 符纸攻击 | 符纸 |
| **道士** | 14 | 防御区域 | 防御 |
| **道士** | 15 | 防御护盾 | 防御 |
| **道士** | 16 | 困魔咒 | 控制 |
| **道士** | 17 | 召唤骷髅 | 召唤 |
| **道士** | 18 | 隐身术 | 辅助 |
| **道士** | 19 | 集体隐身术 | 辅助 |
| **道士** | 21 | 瞬息移动 | 传送 |
| **道士** | 28 | 探查生命 | 辅助 |
| **道士** | 29 | 群体治愈术 | 治疗 |
| **道士** | 30 | 召唤神兽 | 召唤 |
| **道士** | 32 | 圣言术 | 控制 |
| **道士** | 36 | 魔法防御 | 防御 |

### 按释放方式分类

| 释放方式 | 技能列表 | 代码位置 |
|---------|---------|---------|
| **瞬发** | 火球术、大火球、雷电术、治愈术 | `Magic.pas:783-928` |
| **持续** | 火墙 | `Magic.pas:873-877` |
| **被动** | 剑术类技能 (攻杀、刺杀、半月等) | `Magic.pas:46-53` |
| **召唤** | 召唤骷髅、召唤神兽 | `Magic.pas:1120-1173` |
| **范围** | 爆裂火焰、地狱雷光、群体治愈术 | `Magic.pas:878-939` |

### 按效果类型分类

| 效果类型 | 技能列表 | 说明 |
|---------|---------|------|
| **直接伤害** | 火球术、大火球、雷电术、地狱火 | 对目标造成即时伤害 |
| **持续伤害** | 火墙、施毒术 | 在一段时间内持续造成伤害 |
| **治疗** | 治愈术、群体治愈术 | 恢复生命值 |
| **控制** | 困魔咒、圣言术、雷电术(控怪) | 限制目标行动 |
| **增益** | 魔法盾、防御护盾、隐身术 | 提升自身或队友属性 |
| **召唤** | 召唤骷髅、召唤神兽 | 召唤战斗单位 |
| **位移** | 野蛮冲撞、瞬息移动 | 改变位置 |

---

## Epic 级别用户故事

### Epic 1: 技能学习与升级系统

**描述**: 玩家能够学习新技能并通过使用技能来提升技能等级

**涉及模块**:
- `ObjBase.pas:8529-8545` - 技能升级检查
- `Magic.pas:1197-1204` - 修炼值增加
- `Grobal2.pas:590-626` - 技能数据结构

**子故事**: US-001, US-002, US-003

---

### Epic 2: 技能释放与冷却系统

**描述**: 玩家能够释放技能并受到冷却时间限制

**涉及模块**:
- `Magic.pas:441-1208` - SpellNow 主函数
- `ObjBase.pas:8249` - DoSpell 施放入口
- `Grobal2.pas:TDefMagic.DelayTime` - 冷却定义

**子故事**: US-004, US-005, US-006, US-007

---

### Epic 3: 技能伤害计算系统

**描述**: 技能伤害根据技能等级、角色属性和目标防御进行计算

**涉及模块**:
- `Magic.pas:656-684` - 威力计算函数
- `Magic.pas:55-58` - MPow 基础威力
- `M2Share.pas:170-210` - 职业属性加成

**子故事**: US-008, US-009, US-010

---

### Epic 4: 技能特效系统

**描述**: 技能释放时产生视觉效果和状态效果

**涉及模块**:
- `magiceff.pas` - 客户端特效
- `Magic.pas:387-439` - 隐身等状态效果
- `Grobal2.pas` - RM_SPELL 等消息

**子故事**: US-011, US-012, US-013

---

### Epic 5: 职业专属技能系统

**描述**: 不同职业拥有独特的技能体系和战斗风格

**涉及模块**:
- `Magic.pas:46-53` - IsSwordSkill 剑术判断
- `Grobal2.pas:TDefMagic.Job` - 职业限制
- `M2Share.pas:170-210` - 职业属性差异

**子故事**: US-014, US-015, US-016, US-017, US-018, US-019, US-020

---

## 具体用户故事

### US-001: 技能学习

**作为** 玩家
**我想要** 从NPC处学习新技能
**以便** 获得新的战斗能力

**验收标准**:
- [x] 玩家等级达到技能要求等级时可学习
- [x] 职业限制检查 (Job字段)
- [x] 学习后技能添加到 MagicList
- [x] 技能初始等级为0

**技术实现要点**:
- 涉及文件: `ObjBase.pas:10782` - GetMagic 获取技能
- 关键结构: `TUserMagic` (`Grobal2.pas:616-626`)
- 职业检查: `TDefMagic.Job` (0=战士, 1=法师, 2=道士)

**优先级**: P0
**复杂度**: M
**状态**: 已实现

---

### US-002: 技能修炼值积累

**作为** 玩家
**我想要** 通过使用技能积累修炼值
**以便** 提升技能等级

**验收标准**:
- [x] 每次成功施放技能增加1-3点修炼值
- [x] 角色等级需达到当前技能等级要求
- [x] 修炼值达到 MaxTrain[Level] 时触发升级

**技术实现要点**:
- 涉及文件: `Magic.pas:1197-1204` - 修炼值增加逻辑
- 关键方法: `TrainSkill(pum, 1 + Random(3))`
- 数据结构: `TUserMagic.CurTrain`

**优先级**: P0
**复杂度**: S
**状态**: 已实现

---

### US-003: 技能等级提升

**作为** 玩家
**我想要** 技能自动升级当修炼值满足条件
**以便** 获得更强的技能效果

**验收标准**:
- [x] 修炼值达到 MaxTrain[Level] 自动升级
- [x] 技能最高等级为3级
- [x] 升级后重置修炼值
- [x] 发送 RM_MAGIC_LVEXP 消息通知客户端

**技术实现要点**:
- 涉及文件: `ObjBase.pas:8529-8545` - CheckMagicLevelup
- 等级上限: `TDefMagic.MaxTrainLevel` (通常为3)
- 消息协议: `RM_MAGIC_LVEXP`

**优先级**: P0
**复杂度**: S
**状态**: 已实现

---

### US-004: 技能释放

**作为** 玩家
**我想要** 通过快捷键或点击释放技能
**以便** 在战斗中使用技能

**验收标准**:
- [x] 按快捷键触发技能释放
- [x] 检查魔法值是否足够
- [x] 检查技能冷却状态
- [x] 发送 RM_SPELL 消息显示施法动作

**技术实现要点**:
- 涉及文件: `Magic.pas:441-1208` - SpellNow 主函数
- 入口方法: `ObjBase.pas:8249` - DoSpell
- 消息协议: `RM_SPELL`, `RM_MAGICFIRE`

**优先级**: P0
**复杂度**: L
**状态**: 已实现

---

### US-005: 魔法值消耗

**作为** 玩家
**我想要** 释放技能时消耗魔法值
**以便** 平衡技能使用频率

**验收标准**:
- [x] 消耗值根据技能等级计算
- [x] 魔法不足时无法释放
- [x] 消耗公式: `Spell / (MaxTrainLevel+1) * (Level+1)`

**技术实现要点**:
- 涉及文件: `ObjBase.pas:6443` - GetSWSpell
- 数据字段: `TDefMagic.Spell`, `TDefMagic.DefSpell`
- 消耗检查: 施放前验证 `Abil.MP >= SpellCost`

**优先级**: P0
**复杂度**: S
**状态**: 已实现

---

### US-006: 技能冷却

**作为** 玩家
**我想要** 技能释放后进入冷却状态
**以便** 防止技能无限连发

**验收标准**:
- [x] 冷却时间由 DelayTime 定义(毫秒)
- [x] 冷却期间无法再次释放该技能
- [ ] 客户端显示冷却倒计时 (部分实现)

**技术实现要点**:
- 涉及文件: `Grobal2.pas:TDefMagic.DelayTime`
- 冷却检查: 服务器端时间戳比较
- 客户端显示: 需要 `magiceff.pas` 配合

**优先级**: P0
**复杂度**: M
**状态**: 已实现 (客户端UI部分缺失)

---

### US-007: 剑术技能触发

**作为** 战士玩家
**我想要** 普通攻击时自动触发剑术技能
**以便** 增强近战伤害

**验收标准**:
- [x] 剑术技能为被动触发
- [x] IsSwordSkill 判断技能类型
- [x] 攻杀、刺杀、半月等在攻击时触发

**技术实现要点**:
- 涉及文件: `Magic.pas:46-53` - IsSwordSkill
- 剑术ID: 3, 4, 7, 12, 25, 26, 27, 34
- 触发逻辑: 普攻时检查已学剑术并随机触发

**优先级**: P0
**复杂度**: M
**状态**: 已实现

---

### US-008: 技能威力计算

**作为** 玩家
**我想要** 技能伤害根据等级和属性计算
**以便** 感受角色成长

**验收标准**:
- [x] 基础威力: MinPower + Random(MaxPower - MinPower)
- [x] 等级加成: 根据技能等级线性增长
- [x] 0级保留1/4或1/3基础威力

**技术实现要点**:
- 涉及文件: `Magic.pas:656-684`
- GetPower: 0级为1/4威力
- GetPower13: 0级为1/3威力
- 公式: `pw / (MaxTrainLevel+1) * (Level+1)`

**优先级**: P0
**复杂度**: M
**状态**: 已实现

---

### US-009: 职业属性加成

**作为** 玩家
**我想要** 技能伤害受职业属性影响
**以便** 体现职业特色

**验收标准**:
- [x] 法师技能受 MC(魔法攻击) 加成
- [x] 道士技能受 SC(道术攻击) 加成
- [x] 战士技能受 DC(物理攻击) 加成

**技术实现要点**:
- 涉及文件: `M2Share.pas:170-210`
- 法师MC加成: 25级
- 道士SC加成: 17级
- 战士DC加成: 17级

**优先级**: P1
**复杂度**: S
**状态**: 已实现

---

### US-010: 穿透伤害计算

**作为** 法师玩家
**我想要** 穿透技能对路径上所有目标造成伤害
**以便** 高效清理怪物

**验收标准**:
- [x] 地狱火、雷电术为穿透技能
- [x] 伤害沿直线传递
- [x] 每个目标独立计算伤害

**技术实现要点**:
- 涉及文件: `Magic.pas:813-842`
- 方法: MagPassThroughMagic (`ObjBase.pas:8282`)
- 范围: SpitMap 定义穿透路径

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-011: 技能视觉特效

**作为** 玩家
**我想要** 技能释放时显示特效
**以便** 获得良好的战斗体验

**验收标准**:
- [x] 施法动作动画 (RM_SPELL)
- [x] 技能飞行特效 (RM_MAGICFIRE)
- [x] 命中特效 (RM_MAGSTRUCK)

**技术实现要点**:
- 涉及文件: `magiceff.pas` - 客户端特效
- 消息协议: RM_SPELL, RM_MAGICFIRE, RM_MAGSTRUCK
- 特效类型: TDefMagic.EffectType, Effect

**优先级**: P1
**复杂度**: L
**状态**: 已实现

---

### US-012: 状态效果应用

**作为** 玩家
**我想要** 技能产生持续状态效果
**以便** 获得战术优势

**验收标准**:
- [x] 隐身术设置 STATE_TRANSPARENT
- [x] 魔法盾增加防御
- [x] 施毒术造成持续伤害

**技术实现要点**:
- 涉及文件: `Magic.pas:387-439`
- 隐身: MagMakePrivateTransparent
- 魔法盾: MagBubbleDefenceUp (`Magic.pas:899-903`)

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-013: 范围技能效果

**作为** 法师玩家
**我想要** 范围技能影响区域内所有目标
**以便** 进行群体战斗

**验收标准**:
- [x] 爆裂火焰影响周围区域
- [x] 地狱雷光影响周围区域
- [x] 群体治愈术治疗周围队友

**技术实现要点**:
- 涉及文件: `Magic.pas:341-381`
- MagBigExplosion: 爆裂火焰
- MagElecBlizzard: 地狱雷光
- MagBigHealing: 群体治愈术 (`Magic.pas:317-339`)

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-014: 战士野蛮冲撞

**作为** 战士玩家
**我想要** 使用野蛮冲撞推开周围敌人
**以便** 在战斗中创造空间

**验收标准**:
- [x] 推开周围8格内的生物
- [x] 推开距离根据技能等级增加
- [x] 对被推开目标造成伤害

**技术实现要点**:
- 涉及文件: `Magic.pas:61-85` - MagPushArround
- 技能ID: 8(抱月刃), 37(野蛮冲撞)
- 推开逻辑: 检查目标位置是否可移动

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-015: 道士召唤系统

**作为** 道士玩家
**我想要** 召唤骷髅或神兽协助战斗
**以便** 增强战斗能力

**验收标准**:
- [x] 召唤骷髅消耗魔法值
- [x] 召唤神兽需要更高等级
- [x] 召唤物跟随玩家并自动攻击

**技术实现要点**:
- 涉及文件: `Magic.pas:1120-1173`
- 召唤骷髅: ID 17
- 召唤神兽: ID 30
- 召唤物管理: 服务器端 TAnimal 类

**优先级**: P1
**复杂度**: L
**状态**: 已实现

---

### US-016: 道士施毒术

**作为** 道士玩家
**我想要** 对敌人施加毒素效果
**以便** 造成持续伤害或减速

**验收标准**:
- [x] 绿毒造成持续伤害
- [x] 红毒降低目标防御
- [x] 毒素效果有持续时间

**技术实现要点**:
- 涉及文件: `Magic.pas:941-1036`
- 技能ID: 6
- 消息协议: RM_MAKEPOISON
- 毒素类型: 绿毒/红毒

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-017: 道士困魔咒

**作为** 道士玩家
**我想要** 创建结界困住敌人
**以便** 控制战场局势

**验收标准**:
- [x] 创建圆形结界区域
- [x] 结界内敌人无法移动
- [x] 结界有持续时间

**技术实现要点**:
- 涉及文件: `Magic.pas:219-284` - MagMakeHolyCurtain
- 技能ID: 16
- 结界范围: 根据技能等级变化

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-018: 道士瞬息移动

**作为** 道士玩家
**我想要** 瞬间传送到随机位置
**以便** 快速脱离危险

**验收标准**:
- [x] 传送到地图内随机安全位置
- [x] 消耗魔法值
- [x] 有冷却时间限制

**技术实现要点**:
- 涉及文件: `Magic.pas:193-217` - MagLightingSpaceMove
- 技能ID: 21
- 传送逻辑: 随机选择可行走位置

**优先级**: P2
**复杂度**: M
**状态**: 已实现

---

### US-019: 法师火墙技能

**作为** 法师玩家
**我想要** 在地面创建火墙
**以便** 对经过的敌人造成持续伤害

**验收标准**:
- [x] 创建十字形火焰区域
- [x] 火墙持续一定时间
- [x] 经过火墙的敌人受到伤害

**技术实现要点**:
- 涉及文件: `Magic.pas:286-315` - MagMakeFireCross
- 技能ID: 22
- 范围定义: CrossMap (`M2Share.pas:213-300`)

**优先级**: P1
**复杂度**: M
**状态**: 已实现

---

### US-020: 道士圣言术

**作为** 道士玩家
**我想要** 对不死系怪物使用圣言术
**以便** 造成即死效果

**验收标准**:
- [x] 仅对不死系怪物有效
- [x] 成功率根据技能等级和目标等级计算
- [x] 成功时目标即死

**技术实现要点**:
- 涉及文件: `Magic.pas:164-191` - MagTurnUndead
- 技能ID: 32
- 目标检查: LA_UNDEAD 属性

**优先级**: P2
**复杂度**: M
**状态**: 已实现

---

## 边界场景与异常处理

### 场景1: 魔法值不足

**触发条件**: 玩家魔法值低于技能消耗
**预期行为**:
- [x] 技能释放失败
- [x] 显示提示信息
- [ ] 客户端按钮置灰 (缺失)

**代码位置**: `ObjBase.pas:8249` - DoSpell 中检查 MP

---

### 场景2: 技能冷却中

**触发条件**: 技能冷却时间未结束
**预期行为**:
- [x] 技能释放失败
- [ ] 显示剩余冷却时间 (缺失)

**代码位置**: `Grobal2.pas:TDefMagic.DelayTime`

---

### 场景3: 目标无效

**触发条件**: 目标死亡、不存在或超出范围
**预期行为**:
- [x] 技能释放失败
- [x] 不消耗魔法值

**代码位置**: `Magic.pas:441-1208` - SpellNow 中目标检查

---

### 场景4: 符纸消耗不足

**触发条件**: 道士符纸类技能但无符纸
**预期行为**:
- [x] 检查符纸位置 (手镯/腰带)
- [x] 符纸不足时技能失败
- [x] 消耗符纸耐久度

**代码位置**: `Magic.pas:691-718` - CanUseBujuk

---

### 场景5: 职业限制

**触发条件**: 玩家尝试使用非本职业技能
**预期行为**:
- [x] 学习时职业检查
- [x] 非本职业无法学习

**代码位置**: `Grobal2.pas:TDefMagic.Job`

---

### 场景6: 等级不足

**触发条件**: 角色等级低于技能升级要求
**预期行为**:
- [x] 技能无法升级
- [x] 修炼值继续积累但不触发升级

**代码位置**: `Magic.pas:1197-1204` - 等级检查

---

### 场景7: 召唤物数量上限

**触发条件**: 道士已有召唤物时再次召唤
**预期行为**:
- [x] 检查现有召唤物数量
- [x] 超出上限时召唤失败或替换

**代码位置**: `Magic.pas:1120-1173`

---

### 场景8: 隐身状态攻击

**触发条件**: 隐身状态下释放攻击技能
**预期行为**:
- [x] 攻击后解除隐身状态
- [x] 隐身效果立即消失

**代码位置**: `Magic.pas:387-416`

---

## 技术架构总结

### 核心类关系

```
TMagicManager (Magic.pas)
├── SpellNow() - 技能释放主入口
├── IsSwordSkill() - 剑术判断
├── MagPushArround() - 推开效果
├── MagMakeHolyCurtain() - 结界效果
└── MagBigExplosion() - 范围爆炸

TCreature (ObjBase.pas)
├── DoSpell() - 施法入口
├── GetSpellPoint() - 魔法消耗
├── CheckMagicLevelup() - 升级检查
└── MagicList - 技能列表
```

### 消息协议

| 消息 | 用途 |
|------|------|
| RM_SPELL | 施法动作 |
| RM_MAGICFIRE | 魔法飞行 |
| RM_DELAYMAGIC | 延迟伤害 |
| RM_MAGSTRUCK | 魔法命中 |
| RM_MAGHEALING | 魔法治疗 |
| RM_MAGIC_LVEXP | 修炼值更新 |

### 缺失功能清单

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 冷却UI显示 | P1 | 客户端冷却倒计时 |
| 技能打断机制 | P2 | 吟唱中被攻击打断 |
| 技能连招系统 | P2 | 技能组合触发 |
| 技能天赋树 | P2 | 技能分支选择 |

---

## 用户故事统计

| 类别 | 数量 | 已实现 | 缺失 |
|------|------|--------|------|
| Epic | 5 | 5 | 0 |
| User Story | 20 | 20 | 0 |
| 边界场景 | 8 | 8 | 0 |

**总计**: 20个用户故事，全部基于代码分析，标注了具体代码位置。

---

*文档生成完成*
