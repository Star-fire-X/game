# Legend2 地图查看器

用于查看和编辑传奇2游戏地图文件（.map 格式）的桌面工具。

## 功能特性

### 地图查看
- 🗺️ 加载和显示 .map 地图文件
- 🎨 三层渲染：背景层（Tiles）、中间层（SmTiles）、物件层（Objects）
- 🔍 缩放和平移视图
- 📐 显示网格线
- 🚶 显示可行走区域（绿色=可行走，红色=阻挡）

### 地图编辑
- ✏️ 编辑瓦片属性（图层索引、光照等）
- 💾 保存修改后的地图
- 🔄 自动备份原文件

### 图层控制
- 👁️ 独立控制各图层的可见性
- 🎛️ 缩放滑块（10% - 500%）
- 🔲 网格显示开关
- 🚦 可行走性显示开关

## 安装依赖

```bash
cd tools/map_viewer
pip install -r requirements.txt
```

依赖包：
- PyQt5 >= 5.15.0
- Pillow >= 9.0.0
- numpy >= 1.20.0

## 使用方法

### 启动程序

```bash
python main.py
```

或指定地图文件：

```bash
python main.py ../../Map/3.map
```

### 目录结构

程序会自动检测以下目录：
- `Map/` - 地图文件目录
- `Data/` - WIL 资源文件目录（Tiles.wil, SmTiles.wil, Objects.wil 等）

如果自动检测失败，可以通过菜单手动设置：
- **文件 > 打开地图目录** - 设置 Map 目录
- **设置 > 设置 Data 目录** - 设置 Data 目录

### 操作说明

#### 打开地图
1. 方式一：菜单 **文件 > 打开地图文件** (Ctrl+O)
2. 方式二：菜单 **文件 > 打开地图目录** (Ctrl+Shift+O)，然后在文件树中双击地图

#### 查看地图
- **鼠标滚轮** - 缩放视图
- **鼠标拖动** - 平移视图
- **左键点击** - 选择瓦片

#### 编辑瓦片
1. 左键点击选择一个瓦片
2. 在右侧属性面板中编辑属性：
   - 图层索引（背景层、中间层、物件层）
   - 门索引和偏移（传送门）
   - 动画帧数和速度
   - 区域标识
   - 光照强度
3. 点击 **应用修改** 按钮
4. 菜单 **文件 > 保存** (Ctrl+S) 保存地图

#### 图层控制
在右侧图层面板中：
- 勾选/取消勾选图层复选框控制可见性
- 使用缩放滑块或按钮调整缩放
- 显示网格和可行走区域

### 快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+O | 打开地图文件 |
| Ctrl+Shift+O | 打开地图目录 |
| Ctrl+S | 保存地图 |
| Ctrl+Shift+S | 另存为 |
| Ctrl+Q | 退出程序 |
| Ctrl++ | 放大 |
| Ctrl+- | 缩小 |
| Ctrl+0 | 重置缩放 |

## 地图文件格式

### 文件头
- 2 字节：地图宽度 (int16, little-endian)
- 2 字节：地图高度 (int16, little-endian)

### 瓦片数据
每个瓦片 12 字节，按列优先顺序存储：

| 偏移 | 大小 | 类型 | 说明 |
|------|------|------|------|
| 0 | 2 | uint16 | 背景层瓦片索引 (Tiles.wil) |
| 2 | 2 | uint16 | 中间层瓦片索引 (SmTiles.wil) |
| 4 | 2 | uint16 | 物件层瓦片索引 (Objects.wil) |
| 6 | 1 | uint8 | 门索引 |
| 7 | 1 | uint8 | 门偏移 |
| 8 | 1 | uint8 | 动画帧数 |
| 9 | 1 | uint8 | 动画速度 |
| 10 | 1 | uint8 | 区域标识 |
| 11 | 1 | uint8 | 光照强度 |

### 特殊标记
- 背景/物件层高位 (0x8000)：表示阻挡
- 门存在且未打开时不可通行

## 注意事项

1. **备份重要**：保存地图前会自动创建 `.backup` 备份文件
2. **资源依赖**：需要 WIL 资源文件才能正确渲染地图
3. **性能优化**：大地图（>500x500）可能需要较长加载时间
4. **编辑谨慎**：修改地图属性可能影响游戏逻辑，请谨慎操作

## 故障排除

### 地图显示空白
- 检查是否正确设置了 Data 目录
- 确认 Data 目录包含 Tiles.wil、SmTiles.wil、Objects.wil

### 无法加载地图
- 检查地图文件是否损坏
- 确认文件格式正确（.map 扩展名）

### 保存失败
- 检查是否有写入权限
- 确认磁盘空间充足

## 项目结构

```
map_viewer/
├── main.py              # 入口文件
├── map_viewer.py        # 主窗口
├── map_loader.py        # 地图文件解析器
├── wil_loader.py        # WIL 资源加载器
├── map_canvas.py        # 地图画布组件
├── layer_panel.py       # 图层控制面板
├── property_panel.py    # 属性编辑面板
├── tile_data.py         # 瓦片数据结构
├── requirements.txt     # 依赖列表
└── README.md            # 本文件
```

## 许可证

本工具是 mir2-cpp 项目的一部分。
