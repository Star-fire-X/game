# Legend2 地图查看器 - 使用指南

## 快速开始

### 1. 安装依赖

首次使用需要安装 Python 依赖包：

```bash
cd tools/map_viewer
pip install -r requirements.txt
```

### 2. 启动程序

**Windows 用户**：
```bash
run.bat
```

**所有平台**：
```bash
python main.py
```

**直接打开地图文件**：
```bash
python main.py ../../Map/3.map
```

## 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  文件(F)  查看(V)  设置(S)  帮助(H)                     │  ← 菜单栏
├─────────────────────────────────────────────────────────┤
│  [打开] [目录] [保存] | [+] [-] [重置]                  │  ← 工具栏
├────────┬──────────────────────────────┬─────────────────┤
│        │                              │  图层显示       │
│ 地图   │                              │  ☑ 背景层      │
│ 文件   │         地图画布             │  ☑ 中间层      │
│ 列表   │    （可缩放、可平移）        │  ☑ 物件层      │
│        │                              │                 │
│ 3.map  │                              │  显示选项       │
│ 4.map  │                              │  ☐ 显示网格    │
│ ...    │                              │  ☐ 显示可行走  │
│        │                              │                 │
│        │                              │  缩放控制       │
│        │                              │  [━━●━━━━━] 100%│
│        │                              │                 │
│        │                              │  瓦片信息       │
│        │                              │  坐标: (10, 5) │
│        │                              │  可行走: 是     │
│        │                              │                 │
│        │                              │  瓦片属性编辑   │
│        │                              │  背景层: [___]  │
│        │                              │  中间层: [___]  │
│        │                              │  物件层: [___]  │
│        │                              │  ...            │
├────────┴──────────────────────────────┴─────────────────┤
│  就绪                                  坐标: (10, 5)    │  ← 状态栏
└─────────────────────────────────────────────────────────┘
```

## 主要功能

### 地图查看

#### 打开地图
1. **单个文件**：文件 → 打开地图文件 (Ctrl+O)
2. **批量浏览**：文件 → 打开地图目录 (Ctrl+Shift+O)
   - 在左侧文件列表中双击打开

#### 视图操作
- **缩放**：鼠标滚轮 或 Ctrl++ / Ctrl+-
- **平移**：鼠标拖动
- **重置**：Ctrl+0 或点击"重置"按钮

#### 图层控制
在右侧图层面板中：
- **显示/隐藏图层**：勾选对应复选框
  - 背景层 (Tiles.wil)
  - 中间层 (SmTiles.wil)
  - 物件层 (Objects.wil)
- **全选/全不选**：快速切换所有图层

#### 辅助显示
- **网格**：显示瓦片边界网格线
- **可行走性**：
  - 绿色半透明 = 可行走区域
  - 红色半透明 = 阻挡区域

### 地图编辑

#### 选择瓦片
- 左键点击地图上的任意瓦片
- 选中的瓦片会显示黄色虚线边框
- 右侧属性面板显示详细信息

#### 编辑属性
在右侧属性面板可以编辑：

**图层索引**：
- 背景层索引 (0-65535)
- 中间层索引 (0-65535)
- 物件层索引 (0-65535)

**瓦片属性**：
- 门索引 (0-255)：传送门标识
- 门偏移 (0-255)：传送点偏移
- 动画帧数 (0-255)：物件动画帧数
- 动画速度 (0-255)：动画播放速度
- 区域标识 (0-255)：区域分组
- 光照 (0-255)：光照强度

#### 应用修改
1. 修改属性值
2. 点击"应用修改"按钮
3. 地图实时更新显示
4. 窗口标题显示 * 表示有未保存修改

#### 保存地图
- **保存**：文件 → 保存 (Ctrl+S)
  - 自动创建 .backup 备份文件
- **另存为**：文件 → 另存为 (Ctrl+Shift+S)
  - 保存到新文件

## 常见操作流程

### 场景 1: 查看地图布局

1. 启动程序
2. 打开地图目录
3. 双击地图文件
4. 使用鼠标滚轮缩放
5. 拖动查看不同区域
6. 勾选"显示网格"辅助定位

### 场景 2: 检查可行走区域

1. 打开地图
2. 勾选"显示可行走区域"
3. 检查红色（阻挡）和绿色（可行走）分布
4. 点击特定瓦片查看光照值

### 场景 3: 修改传送点

1. 打开地图
2. 点击要设置传送点的瓦片
3. 在属性面板设置：
   - 门索引 > 0（启用传送门）
   - 门偏移（如需要）
4. 点击"应用修改"
5. 保存地图

### 场景 4: 批量查看多个地图

1. 打开地图目录
2. 左侧列表显示所有地图
3. 双击切换不同地图
4. 快速对比地图结构

## 技巧与注意事项

### 性能优化
- **大地图加载慢**：首次加载大地图（>500x500）需要时间
- **缓存机制**：已加载的瓦片会被缓存，再次查看更快
- **只渲染可见区域**：视口外的瓦片不会渲染

### 编辑建议
- **先备份**：重要地图建议手动备份
- **小步修改**：每次只修改少量瓦片，及时保存
- **测试验证**：修改后在游戏中测试效果

### 常见问题

**Q: 地图显示空白？**
A: 
1. 确认设置了正确的 Data 目录
2. 检查 Data 目录包含 WIL 文件
3. 菜单 → 设置 → 设置 Data 目录

**Q: 保存失败？**
A:
1. 检查文件是否只读
2. 确认有写入权限
3. 磁盘空间是否充足

**Q: 修改不生效？**
A:
1. 确认点击了"应用修改"
2. 确认保存了地图文件
3. 重新加载地图查看

**Q: 图像显示不正确？**
A:
1. 确认 WIL 文件完整
2. 检查图层索引是否正确
3. 尝试重新加载地图

## 文件格式参考

### 地图文件 (.map)

**文件头（4字节）**：
```
[0-1] 宽度 (int16, little-endian)
[2-3] 高度 (int16, little-endian)
```

**瓦片数据（每个12字节）**：
```
[0-1]  背景层索引 (uint16)
[2-3]  中间层索引 (uint16)
[4-5]  物件层索引 (uint16)
[6]    门索引 (uint8)
[7]    门偏移 (uint8)
[8]    动画帧数 (uint8)
[9]    动画速度 (uint8)
[10]   区域标识 (uint8)
[11]   光照 (uint8)
```

### 光照说明
- 取值范围 0..4（常见）
- 光照不影响可行走性

- `0x00`：可行走
- `0x01`, `0x03`, `0x04`, `0x05`：阻挡

物件层高位 `0x8000`：表示该物件阻挡移动

## 快捷键参考

| 功能 | 快捷键 |
|------|--------|
| 打开文件 | Ctrl+O |
| 打开目录 | Ctrl+Shift+O |
| 保存 | Ctrl+S |
| 另存为 | Ctrl+Shift+S |
| 退出 | Ctrl+Q |
| 放大 | Ctrl++ 或 鼠标滚轮向上 |
| 缩小 | Ctrl+- 或 鼠标滚轮向下 |
| 重置缩放 | Ctrl+0 |

## 获取帮助

- 菜单 → 帮助 → 关于：查看版本信息
- GitHub Issues：报告问题或建议
- README.md：详细技术文档

---

祝使用愉快！如有问题请反馈。
