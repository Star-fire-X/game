# 地图系统用户故事文档

## 文档信息

| 属性 | 值 |
|------|-----|
| 系统名称 | 传奇2地图系统 (Map System) |
| 版本 | 1.0 |
| 创建日期 | 2026-01-15 |
| 相关源码 | `MapUnit.pas`, `PlayScn.pas`, `Envir.pas`, `Event.pas` |

---

## 目录

1. [系统概述](#1-系统概述)
2. [用户角色定义](#2-用户角色定义)
3. [用户故事列表](#3-用户故事列表)
   - [Epic 1: 地图加载与管理](#epic-1-地图加载与管理)
   - [Epic 2: 地图渲染与显示](#epic-2-地图渲染与显示)
   - [Epic 3: 移动与碰撞检测](#epic-3-移动与碰撞检测)
   - [Epic 4: 传送系统](#epic-4-传送系统)
   - [Epic 5: 门系统](#epic-5-门系统)
   - [Epic 6: 小地图系统](#epic-6-小地图系统)
   - [Epic 7: 地图事件系统](#epic-7-地图事件系统)
   - [Epic 8: 地图属性与限制](#epic-8-地图属性与限制)
4. [验收标准汇总](#4-验收标准汇总)
5. [技术约束](#5-技术约束)

---

## 1. 系统概述

地图系统是传奇2游戏的核心基础设施，负责游戏世界的空间表现和管理。系统采用瓦片地图技术，支持大规模地图的分块加载、多层渲染、以及丰富的交互功能。

### 1.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      地图系统架构                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  地图文件   │  │  地图渲染   │  │    地图交互        │  │
│  │  管理模块   │  │  引擎模块   │  │    处理模块        │  │
│  │             │  │             │  │                    │  │
│  │ ·文件解析   │  │ ·三层渲染   │  │ ·移动检测         │  │
│  │ ·分块加载   │  │ ·动画系统   │  │ ·传送处理         │  │
│  │ ·缓存管理   │  │ ·光源效果   │  │ ·门控制           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  小地图     │  │  事件系统   │  │    属性系统        │  │
│  │  显示模块   │  │  管理模块   │  │    配置模块        │  │
│  │             │  │             │  │                    │  │
│  │ ·缩略显示   │  │ ·火焰事件   │  │ ·安全区           │  │
│  │ ·位置标记   │  │ ·采矿事件   │  │ ·战斗区           │  │
│  │ ·组队标记   │  │ ·触发器     │  │ ·黑暗地图         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 数据结构

| 结构名 | 用途 | 关键字段 |
|--------|------|----------|
| TMapHeader | 地图文件头 | Width, Height, Title |
| TMapInfo | 地图格子信息 | BkImg, MidImg, FrImg, DoorIndex, light |
| TMap | 地图管理类 | MArr, ClientRect, BlockLeft, BlockTop |
| TEnvirnoment | 服务端地图环境 | MapName, MMap, DoorList, MapQuestList |

---

## 2. 用户角色定义

| 角色 | 描述 | 主要交互 |
|------|------|----------|
| **玩家 (Player)** | 游戏的主要使用者 | 在地图中移动、探索、战斗 |
| **系统 (System)** | 客户端/服务端程序 | 加载地图、渲染画面、处理逻辑 |
| **GM (Game Master)** | 游戏管理员 | 地图配置、传送玩家、事件管理 |

---

## 3. 用户故事列表

---

### Epic 1: 地图加载与管理

#### US-MAP-001: 加载地图文件

**作为** 系统  
**我想要** 能够加载并解析地图文件  
**以便于** 正确显示游戏世界

**验收标准：**
- [ ] 能正确读取 `.map` 文件格式
- [ ] 支持解析地图文件头（宽度、高度、标题）
- [ ] 能加载地图单元格数据（背景、中层、前景图像索引）
- [ ] 支持读取门信息、动画帧数、光源效果

**技术说明：**
```pascal
TMapHeader = packed record
   Width  : word;        // 地图宽度（格子数）
   Height : word;        // 地图高度（格子数）
   Title: string[20];    // 地图标题
   UpdateDate: TDateTime; // 更新日期
end;
```

---

#### US-MAP-002: 分块加载地图

**作为** 系统  
**我想要** 按区块动态加载地图数据  
**以便于** 减少内存占用并提高加载效率

**验收标准：**
- [ ] 地图按 `LOGICALMAPUNIT` (40格) 为单位分块
- [ ] 以玩家为中心加载 3x3 区块
- [ ] 玩家移动时自动更新需要加载的区块
- [ ] 区块数据缓存在 `MArr[0..MAXX*3, 0..MAXY*3]` 数组中

**技术说明：**
```pascal
procedure TMap.UpdateMapSquare (cx, cy: integer);
// 当区块索引变化时重新加载地图数据
```

---

#### US-MAP-003: 解密加密地图

**作为** 系统  
**我想要** 能够解密特殊加密的地图  
**以便于** 支持迷宫等保密地图

**验收标准：**
- [ ] 识别加密地图（LABY01-04, SNAKE）
- [ ] 使用 `CheckKey = 43576` 进行 XOR 解密
- [ ] 正确解密 Width、Height、BkImg、MidImg、FrImg 字段

---

#### US-MAP-004: 地图重新加载

**作为** 玩家  
**我想要** 在切换地图时能够平滑过渡  
**以便于** 获得流畅的游戏体验

**验收标准：**
- [ ] 调用 `LoadMap` 时重置区块索引
- [ ] 正确更新当前地图名称
- [ ] 触发地图位置更新

---

### Epic 2: 地图渲染与显示

#### US-MAP-005: 三层地图渲染

**作为** 玩家  
**我想要** 看到层次分明的地图画面  
**以便于** 获得良好的视觉体验

**验收标准：**
- [ ] 背景层 (BkImg): 绘制大地砖 (96x64)，每2x2格一个
- [ ] 中间层 (MidImg): 绘制小地砖装饰物 (48x32)
- [ ] 前景层 (FrImg): 绘制物件（建筑、树木等）
- [ ] 支持透明绘制和混合绘制

**技术说明：**
```pascal
procedure TPlayScene.DrawTileMap;
// 依次绘制背景层、中间层瓦片
```

---

#### US-MAP-006: 地图动画效果

**作为** 玩家  
**我想要** 看到地图上的动态效果  
**以便于** 让游戏世界更生动

**验收标准：**
- [ ] 支持地图物件动画（AniFrame 帧数）
- [ ] 支持动画帧间隔控制（AniTick）
- [ ] 支持 Alpha 混合动画（AniFrame 最高位 $80）
- [ ] 动画与主循环计数器同步

---

#### US-MAP-007: 门动画效果

**作为** 玩家  
**我想要** 看到门开关时的动画  
**以便于** 直观感知门的状态

**验收标准：**
- [ ] 门打开时显示打开状态的图像帧
- [ ] DoorOffset 的 $80 位表示开/关状态
- [ ] 支持多帧门动画偏移

---

#### US-MAP-008: 光源效果

**作为** 玩家  
**我想要** 在黑暗地图中有光源照明  
**以便于** 体验真实的地下城环境

**验收标准：**
- [ ] 支持地图黑暗等级 (DarkLevel) 设置
- [ ] 光源信息存储在 TMapInfo.light 字段 (0-4级)
- [ ] 玩家角色周围有照明范围
- [ ] 支持日夜变化效果 (DayLight)

---

#### US-MAP-009: 死亡灰度效果

**作为** 玩家  
**我想要** 在死亡时看到灰度画面  
**以便于** 清晰知道自己的死亡状态

**验收标准：**
- [ ] 玩家死亡时地图渲染为灰度效果
- [ ] 调用 `DrawEffect(ObjSurface, ceGrayScale)`

---

### Epic 3: 移动与碰撞检测

#### US-MAP-010: 行走检测

**作为** 玩家  
**我想要** 不能穿过障碍物  
**以便于** 保证游戏的真实性

**验收标准：**
- [ ] 检测 BkImg 和 FrImg 的 $8000 标志位（不可行走）
- [ ] 检测门的开关状态
- [ ] 返回是否可以移动的布尔值

**技术说明：**
```pascal
function TMap.CanMove (mx, my: integer): Boolean;
// Result := ((BkImg and $8000) + (FrImg and $8000)) = 0
```

---

#### US-MAP-011: 飞行检测

**作为** 玩家（使用飞行技能）  
**我想要** 能够飞越部分障碍物  
**以便于** 利用技能优势

**验收标准：**
- [ ] 只检测 FrImg 的 $8000 标志位
- [ ] 不检测背景障碍（可飞越水面等）
- [ ] 仍需检查门的状态

---

#### US-MAP-012: 位置标记

**作为** 系统  
**我想要** 能够标记地图位置的可行走状态  
**以便于** 动态控制通行

**验收标准：**
- [ ] 支持 `MarkCanWalk(mx, my, bowalk)` 动态修改
- [ ] 设置/清除 FrImg 的 $8000 标志位

---

#### US-MAP-013: 特定地图修正

**作为** 系统  
**我想要** 修正特定地图的bug  
**以便于** 保证游戏正常进行

**验收标准：**
- [ ] 3号地图城墙位置自动修正（2001-7-3）
- [ ] 修正坐标：(624,278), (627,278), (634,271) 等

---

### Epic 4: 传送系统

#### US-MAP-014: 传送门触发

**作为** 玩家  
**我想要** 走到传送门时自动传送  
**以便于** 方便地在地图间移动

**验收标准：**
- [ ] 检测 OS_GATEOBJECT 类型的地图对象
- [ ] 获取传送门的目标地图和坐标
- [ ] 触发地图切换流程
- [ ] 支持需要洞穴的特殊传送（尸王殿）

**技术说明：**
```pascal
if pat.Shape = OS_GATEOBJECT then begin
   pgate := PTGateInfo (pat.AObject);
end;
```

---

#### US-MAP-015: 同服务器传送

**作为** 玩家  
**我想要** 在同服务器内传送  
**以便于** 快速移动

**验收标准：**
- [ ] 从旧地图删除角色对象
- [ ] 清理可见列表（VisibleActors, VisibleItems）
- [ ] 在新地图添加角色对象
- [ ] 发送 RM_CHANGEMAP 消息

---

#### US-MAP-016: 跨服务器传送

**作为** 玩家  
**我想要** 能够传送到其他服务器的地图  
**以便于** 访问所有游戏区域

**验收标准：**
- [ ] 设置 BoChangeServer 标志
- [ ] 记录目标服务器编号
- [ ] 触发 EmergencyClose 和 SoftClosed
- [ ] 保持认证状态不中断

---

#### US-MAP-017: 回城卷使用

**作为** 玩家  
**我想要** 使用回城卷传送回城  
**以便于** 快速返回安全区

**验收标准：**
- [ ] 正常玩家传送到 HomeMap (HomeX, HomeY)
- [ ] 红名玩家（PKLevel >= 2）传送到红名村
- [ ] 显示传送隐藏效果 (RM_SPACEMOVE_HIDE)

---

#### US-MAP-018: 地牢传送卷使用

**作为** 玩家  
**我想要** 使用地牢传送卷随机传送  
**以便于** 在当前地图随机移动

**验收标准：**
- [ ] 在当前地图内随机选择坐标
- [ ] 检查地图是否禁止随机移动 (NoRandomMove)
- [ ] 攻城战内城有10秒冷却时间

---

#### US-MAP-019: NPC传送

**作为** 玩家  
**我想要** 通过NPC对话传送  
**以便于** 到达特定目的地

**验收标准：**
- [ ] NPC执行 QA_MAPMOVE 动作
- [ ] 支持指定目标地图和坐标
- [ ] 支持 QA_MAPRANDOM 随机传送

---

### Epic 5: 门系统

#### US-MAP-020: 获取门信息

**作为** 系统  
**我想要** 获取地图上的门信息  
**以便于** 处理门的交互

**验收标准：**
- [ ] DoorIndex 的 $80 位表示是否有门
- [ ] 低7位为门的识别索引
- [ ] GetDoor 返回门索引

---

#### US-MAP-021: 检查门状态

**作为** 玩家  
**我想要** 知道门是否打开  
**以便于** 决定是否能通过

**验收标准：**
- [ ] DoorOffset 的 $80 位表示开/关状态
- [ ] IsDoorOpen 返回布尔值

---

#### US-MAP-022: 开门操作

**作为** 玩家  
**我想要** 能够打开门  
**以便于** 通过门

**验收标准：**
- [ ] 遍历周围 20x20 范围
- [ ] 找到相同索引的门
- [ ] 设置所有相关门的 DoorOffset $80 位

---

#### US-MAP-023: 关门操作

**作为** 系统  
**我想要** 能够自动关门  
**以便于** 维护门的状态

**验收标准：**
- [ ] 遍历周围 18x20 范围
- [ ] 找到相同索引的门
- [ ] 清除所有相关门的 DoorOffset $80 位

---

#### US-MAP-024: 门锁功能

**作为** GM  
**我想要** 能够锁定门  
**以便于** 控制玩家通行

**验收标准：**
- [ ] 支持门的锁定状态 (Lock)
- [ ] 支持锁密码 (LockKey)
- [ ] 锁定的门无法被普通方式打开

---

### Epic 6: 小地图系统

#### US-MAP-025: 显示小地图

**作为** 玩家  
**我想要** 在屏幕角落看到小地图  
**以便于** 了解周围环境

**验收标准：**
- [ ] 小地图显示在屏幕右上角 (SCREENWIDTH-120)
- [ ] 显示 120x120 像素的区域
- [ ] 支持透明/不透明两种模式 (ViewMiniMapStyle)

**技术说明：**
```pascal
procedure TPlayScene.DrawMiniMap (surface: TTexture; transparent: Boolean);
```

---

#### US-MAP-026: 小地图角色标记

**作为** 玩家  
**我想要** 在小地图上看到角色位置  
**以便于** 快速定位

**验收标准：**
- [ ] 自己的位置用白色 (255) 标记
- [ ] NPC/商人用颜色 251 标记
- [ ] 怪物用颜色 249 标记
- [ ] 组队成员用颜色 252 标记

---

#### US-MAP-027: 本地小地图绘制

**作为** 系统  
**我想要** 能够本地绘制小地图  
**以便于** 支持没有预制小地图的地图

**验收标准：**
- [ ] 按 SCALE=4 比例缩放
- [ ] 依次绘制背景、中层、前景
- [ ] 使用 StretchDraw 进行缩放绘制

---

### Epic 7: 地图事件系统

#### US-MAP-028: 火焰事件

**作为** 玩家（法师）  
**我想要** 火焰魔法在地图上产生持续伤害区域  
**以便于** 对敌人造成范围伤害

**验收标准：**
- [ ] 火焰事件 (TFireBurnEvent) 创建在指定坐标
- [ ] 持续一定时间后自动消失
- [ ] 对范围内敌人造成伤害

---

#### US-MAP-029: 采矿事件

**作为** 玩家  
**我想要** 在矿洞中采集矿石  
**以便于** 获取资源

**验收标准：**
- [ ] 矿石事件 (TStoneMineEvent) 标记采矿点
- [ ] 采矿后产生石堆事件 (TPileStones)
- [ ] 事件有生命周期管理

---

#### US-MAP-030: 圣言术事件

**作为** 玩家（道士）  
**我想要** 圣言术在地图上产生效果区域  
**以便于** 对不死生物造成伤害

**验收标准：**
- [ ] 圣言术事件 (THolyCurtainEvent) 在指定位置
- [ ] 对不死系怪物有效
- [ ] 持续时间可配置

---

#### US-MAP-031: 事件管理器

**作为** 系统  
**我想要** 统一管理所有地图事件  
**以便于** 保证事件正常运行

**验收标准：**
- [ ] EventManager 管理活动事件列表
- [ ] 定期运行所有事件的 Run 方法
- [ ] 已关闭事件移入 ClosedList
- [ ] 关闭超过5分钟的事件被销毁

---

### Epic 8: 地图属性与限制

#### US-MAP-032: 安全区

**作为** 玩家  
**我想要** 在安全区内不被PK  
**以便于** 安心交易和休息

**验收标准：**
- [ ] LawFull 属性标记安全区
- [ ] 安全区内禁止玩家间攻击
- [ ] 可视化安全区边界

---

#### US-MAP-033: 战斗区

**作为** 玩家  
**我想要** 在战斗区体验PK  
**以便于** 进行竞技

**验收标准：**
- [ ] FightZone 属性标记战斗区
- [ ] Fight3Zone 支持3次复活区域
- [ ] 战斗区死亡规则特殊处理

---

#### US-MAP-034: 黑暗地图

**作为** 玩家  
**我想要** 在黑暗地图中体验探索乐趣  
**以便于** 增加游戏挑战

**验收标准：**
- [ ] Darkness 属性标记黑暗地图
- [ ] 视野范围受限
- [ ] 需要照明道具或技能

---

#### US-MAP-035: 禁止召唤区

**作为** 系统  
**我想要** 某些地图禁止召唤  
**以便于** 平衡游戏

**验收标准：**
- [ ] NoRecall 属性禁止召唤其他玩家
- [ ] 禁止使用召唤类技能

---

#### US-MAP-036: 禁止随机移动

**作为** 系统  
**我想要** 某些地图禁止随机移动  
**以便于** 保护特定区域

**验收标准：**
- [ ] NoRandomMove 属性生效
- [ ] 地牢传送卷无法使用
- [ ] 随机传送技能失效

---

#### US-MAP-037: 禁止药品区

**作为** 系统  
**我想要** 某些地图禁止使用药品  
**以便于** 增加挑战难度

**验收标准：**
- [ ] NoDrug 属性生效
- [ ] 所有药品类物品无法使用

---

#### US-MAP-038: 等级限制

**作为** 系统  
**我想要** 某些地图有等级要求  
**以便于** 控制玩家进度

**验收标准：**
- [ ] NeedLevel 属性检查
- [ ] 等级不足时禁止进入
- [ ] 显示等级要求提示

---

#### US-MAP-039: 任务限制

**作为** 系统  
**我想要** 某些地图需要完成任务才能进入  
**以便于** 引导游戏流程

**验收标准：**
- [ ] MapQuest NPC 检查任务状态
- [ ] NeedSetNumber 和 NeedSetValue 验证任务标记
- [ ] 未完成任务时阻止进入

---

#### US-MAP-040: 矿洞地图

**作为** 玩家  
**我想要** 在矿洞地图采矿  
**以便于** 获取矿石资源

**验收标准：**
- [ ] MineMap 属性标记矿洞编号
- [ ] 支持采矿交互
- [ ] 矿石刷新机制

---

## 4. 验收标准汇总

### 功能覆盖率

| 模块 | 用户故事数 | 关键功能 |
|------|-----------|----------|
| 地图加载 | 4 | 文件解析、分块加载、加密解密 |
| 地图渲染 | 5 | 三层渲染、动画、光源 |
| 移动检测 | 4 | 行走、飞行、位置标记 |
| 传送系统 | 6 | 传送门、卷轴、NPC传送 |
| 门系统 | 5 | 开关、锁定、状态检查 |
| 小地图 | 3 | 显示、标记、本地绘制 |
| 事件系统 | 4 | 火焰、采矿、圣言、管理器 |
| 属性限制 | 9 | 安全区、战斗区、各种限制 |

### 性能要求

| 指标 | 要求 |
|------|------|
| 地图加载时间 | < 500ms |
| 渲染帧率 | >= 30 FPS |
| 小地图刷新 | 实时 |
| 传送响应 | < 200ms |

---

## 5. 技术约束

### 5.1 地图文件格式

```
地图文件结构:
┌─────────────────────────────────┐
│ TMapHeader (52字节)             │
│ - Width: word                   │
│ - Height: word                  │
│ - Title: string[20]             │
│ - UpdateDate: TDateTime         │
│ - Reserved: array[0..18]        │
├─────────────────────────────────┤
│ TMapInfo 数组                    │
│ (Width * Height 个单元)          │
│ 每个单元 12 字节:                │
│ - BkImg: word                   │
│ - MidImg: word                  │
│ - FrImg: word                   │
│ - DoorIndex: byte               │
│ - DoorOffset: byte              │
│ - AniFrame: byte                │
│ - AniTick: byte                 │
│ - Area: byte                    │
│ - light: byte                   │
└─────────────────────────────────┘
```

### 5.2 坐标系统

| 常量 | 值 | 说明 |
|------|-----|------|
| UNITX | 48 | X方向单元像素宽度 |
| UNITY | 32 | Y方向单元像素高度 |
| LOGICALMAPUNIT | 40 | 逻辑区块单元数 |
| MAXX | 40 | 区块X方向最大格数 |
| MAXY | 40 | 区块Y方向最大格数 |

### 5.3 标志位定义

| 标志位 | 位置 | 含义 |
|--------|------|------|
| $8000 | BkImg/FrImg 最高位 | 不可行走 |
| $80 | DoorIndex 最高位 | 此位置有门 |
| $7F | DoorIndex 低7位 | 门的识别索引 |
| $80 | DoorOffset 最高位 | 门打开状态 |
| $7F | DoorOffset 低7位 | 门图像偏移 |
| $80 | AniFrame 最高位 | Alpha 混合绘制 |
| $7F | AniFrame 低7位 | 动画帧数 |

### 5.4 客户端-服务端通信

| 消息 | 方向 | 说明 |
|------|------|------|
| SM_CHANGEMAP | S→C | 通知客户端切换地图 |
| SM_NEWMAP | S→C | 通知客户端加载新地图 |
| RM_SPACEMOVE_HIDE | S→C | 传送消失效果 |
| RM_SPACEMOVE_SHOW | S→C | 传送出现效果 |
| RM_CHANGEMAP | 内部 | 服务端地图切换消息 |

---

## 附录：相关源码文件

| 文件 | 位置 | 主要内容 |
|------|------|----------|
| MapUnit.pas | Source/Client/ | 客户端地图管理类 |
| PlayScn.pas | Source/Client/ | 地图渲染和小地图 |
| Envir.pas | Source/M2Server/ | 服务端地图环境 |
| Event.pas | Source/M2Server/ | 地图事件系统 |
| ObjBase.pas | Source/M2Server/ | 角色移动和传送 |
| magiceff.pas | Source/Client/ | 地图特效渲染 |
