# 传奇世界（翎风版）- 装备与物品系统详解

## 文档信息
- **项目名称**: GameOfMir翎风 (传奇世界 - 翎风版)
- **版本**: 20020522
- **文档日期**: 2025-10-18
- **基于**: 实际代码库分析

---

## 目录
1. [装备系统](#1-装备系统)
2. [物品数据结构](#2-物品数据结构)
3. [物品类型与属性](#3-物品类型与属性)
4. [物品强化系统](#4-物品强化系统)
5. [耐久度与修理系统](#5-耐久度与修理系统)
6. [特殊装备效果](#6-特殊装备效果)
7. [背包与仓库系统](#7-背包与仓库系统)
8. [物品交易系统](#8-物品交易系统)
9. [物品掉落系统](#9-物品掉落系统)
10. [物品制作与合成](#10-物品制作与合成)

---

## 1. 装备系统

### 1.1 装备槽位（13个槽位）

游戏中角色拥有13个装备槽位,每个槽位只能装备特定类型的物品。

| 槽位ID | 常量名 | 装备类型 | 典型物品 |
|--------|--------|---------|---------|
| 0 | U_DRESS | 衣服/护甲 | 布袍、重甲、轻甲 |
| 1 | U_WEAPON | 主武器 | 剑、法杖、魔杖 |
| 2 | U_RIGHTHAND | 副手/盾牌 | 盾牌、火把、副手武器 |
| 3 | U_NECKLACE | 项链 | 护身符、项链 |
| 4 | U_HELMET | 头盔 | 头盔、帽子、王冠 |
| 5 | U_ARMRINGL | 左手镯 | 手镯、臂环 |
| 6 | U_ARMRINGR | 右手镯 | 手镯、臂环 |
| 7 | U_RINGL | 左戒指 | 各类戒指 |
| 8 | U_RINGR | 右戒指 | 各类戒指 |
| 9 | U_BUJUK | 护身符 | 护身符、符咒（道士专用） |
| 10 | U_BELT | 腰带 | 腰带、束带 |
| 11 | U_BOOTS | 靴子 | 靴子、鞋子 |
| 12 | U_CHARM | 宝石/符文 | 特殊宝石、符文 |

**装备数组定义:**
```pascal
// 所有13个装备槽位
THumanUseItems = array[0..12] of TUserItem

// 前9个槽位（基础装备）
THumItems = array[0..8] of TUserItem

// 后4个槽位（扩展装备：腰带、靴子、宝石）
THumAddItems = Array[9..12] of TUserItem
```

### 1.2 装备限制与验证

**职业限制:**
- **战士**: 可装备重甲、盾牌、近战武器
- **法师**: 可装备布甲、法杖、魔杖
- **道士**: 可装备轻甲、护身符、道士武器

**等级限制:**
- 每件装备都有等级要求（NeedLevel字段）
- 玩家等级必须达到要求才能装备

**属性限制:**
- 装备可能需要特定的DC/MC/SC属性值
- Need字段指定要求类型：
  - `Need = 0`: 等级要求
  - `Need = 1`: DC（物理攻击）要求
  - `Need = 2`: MC（魔法攻击）要求
  - `Need = 3`: SC（精神攻击）要求

**装备验证函数:**
```pascal
// 检查物品是否可以装备到指定槽位
function CheckTakeOnItems(nWhere: Integer; var StdItem: TStdItem): Boolean
  - 验证职业要求（战士/法师/道士）
  - 检查等级要求（NeedLevel）
  - 验证属性要求（DC/MC/SC基于Need字段）
  - 验证性别限制
  - 检查城堡所有权（特殊物品）

// 检查物品是否可以使用/装备
function CheckItemBindUse(UserItem: pTUserItem): Boolean
  - 验证账号绑定
  - 检查角色绑定
  - 验证绑定限制

// 验证装备物品是否在正确的槽位
function CheckUserItems(nWhere: Integer; StdItem: pTStdItem): Boolean
  - 槽位 0 (U_DRESS): 仅护甲 (StdMode = 10, 11)
  - 槽位 1 (U_WEAPON): 仅武器 (StdMode = 5, 6)
  - 槽位 2 (U_RIGHTHAND): 盾牌/火把 (StdMode = 30, 31)
  - 槽位 3 (U_NECKLACE): 项链 (StdMode = 19, 20, 21, 24)
  - 槽位 4 (U_HELMET): 头盔 (StdMode = 15, 16)
  - 槽位 5-6 (U_ARMRINGL/R): 手镯 (StdMode = 26)
  - 槽位 7-8 (U_RINGL/R): 戒指 (StdMode = 22, 23)
  - 槽位 9 (U_BUJUK): 护身符 (StdMode = 25)
  - 槽位 10 (U_BELT): 腰带 (StdMode = 54)
  - 槽位 11 (U_BOOTS): 靴子 (StdMode = 52)
  - 槽位 12 (U_CHARM): 宝石 (StdMode = 64)
```

---

## 2. 物品数据结构

### 2.1 TStdItem（标准物品定义）- 60字节

这是物品模板定义,存储在服务器的物品数据库中。

```pascal
TStdItem = packed record                    // 总计60字节
  Name: String[14];        // +15  物品名称（最多14个字符）
  StdMode: Byte;           // +1   物品类型/分类
  Shape: Byte;             // +1   外观形状/样式
  Weight: Byte;            // +1   物品重量（影响负重）
  AniCount: Byte;          // +1   动画帧数
  Source: shortint;        // +1   神圣值/诅咒值
  reserved: byte;          // +1   保留字节
  NeedIdentify: byte;      // +1   是否需要鉴定（0=否, 1=是）
  Looks: Word;             // +2   Items.WIL文件中的图形索引
  DuraMax: DWord;          // +4   最大耐久度
  AC: DWord;               // +4   物理防御（护甲值）
  MAC: DWord;              // +4   魔法防御
  DC: DWord;               // +4   物理攻击力
  MC: DWord;               // +4   魔法攻击力
  SC: DWord;               // +4   精神攻击力
  Need: DWord;             // +4   需求类型：
                           //      0 = 等级需求
                           //      1 = DC需求
                           //      2 = MC需求
                           //      3 = SC需求
  NeedLevel: DWord;        // +4   Need类型对应的需求值
  Price: Integer;          // +4   基础价格（金币）
end;
```

**字段说明:**
- **Name**: 物品显示名称,最多14个字符
- **StdMode**: 物品大类（武器、防具、饰品等）
- **Shape**: 物品子类型,用于细分同一StdMode下的不同物品
- **Weight**: 单个物品重量,影响角色负重
- **AniCount**: 物品图标动画帧数（0=静态）
- **Source**: 神圣/诅咒值（正数=神圣,负数=诅咒）
- **NeedIdentify**: 是否需要鉴定才能查看完整属性
- **Looks**: 物品图标在WIL图像库中的索引
- **DuraMax**: 物品的最大耐久度值
- **AC/MAC**: 防御属性（LoWord=最小值, HiWord=最大值）
- **DC/MC/SC**: 攻击属性（LoWord=最小值, HiWord=最大值）
- **Need**: 装备需求类型
- **NeedLevel**: 装备需求的具体数值
- **Price**: NPC商店基础价格

### 2.2 TUserItem（玩家物品实例）- 24字节

这是玩家实际拥有的物品实例,每个物品都有唯一ID和独立属性。

```pascal
TUserItem = record                          // 总计24字节
  MakeIndex: Integer;              // +4   唯一物品实例ID
  wIndex: Word;                    // +2   物品类型索引（引用TStdItem）
  Dura: word;                      // +2   当前耐久度
  DuraMax: Word;                   // +2   最大耐久度
  btValue: Array[0..13] of byte;   // +14  附加值（随机加成等）
end;
```

**字段说明:**
- **MakeIndex**: 全局唯一的物品实例ID,用于区分不同的物品
- **wIndex**: 指向TStdItem的索引,确定物品的基础属性
- **Dura**: 当前耐久度,使用后会降低
- **DuraMax**: 该实例的最大耐久度（可能因修理而降低）
- **btValue**: 14字节的附加数据数组,存储:
  - 随机属性加成（DC/MC/SC/AC/MAC）
  - 物品绑定状态（btValue[7]）
  - 强化等级
  - 特殊效果标记
  - 堆叠数量（消耗品）

### 2.3 TClientItem（客户端物品）

客户端显示用的物品结构,包含完整的物品信息。

```pascal
TClientItem = record
  S: TStdItem;          // 标准物品定义
  MakeIndex: Integer;   // 唯一实例ID
  Dura: Word;           // 当前耐久度
  DuraMax: Word;        // 最大耐久度
end;
```

### 2.4 物品容器数组

```pascal
// 背包物品（46个槽位）
TBagItems = Array[0..45] of TUserItem
const MAXBAGITEM = 46;

// 仓库物品（40个槽位）
TStorageItems = Array[0..39] of TUserItem

// 装备物品（13个槽位）
THumanUseItems = array[0..12] of TUserItem
```

---

## 3. 物品类型与属性

### 3.1 物品类型分类（StdMode）

| StdMode | 常量名 | 分类 | 描述 |
|---------|--------|------|------|
| 0 | ITEM_WEAPON | 武器 | 剑、法杖、魔杖等 |
| 1 | ITEM_ARMOR | 护甲 | 布甲、皮甲、重甲 |
| 2 | ITEM_ACCESSORY | 饰品 | 戒指、项链、手镯 |
| 3 | ITEM_ETC | 杂物 | 消耗品、材料、任务物品 |
| 10 | ITEM_GOLD | 金币 | 游戏货币 |

### 3.2 详细物品子类型（Shape）

**武器类（StdMode = 5, 6）:**
- 单手剑、双手剑
- 法杖、魔杖
- 刀、斧、锤

**护甲类（StdMode = 10, 11）:**
- 布甲（法师）
- 皮甲（道士）
- 重甲（战士）

**饰品类:**
- **项链** (StdMode = 19, 20, 21, 24)
- **戒指** (StdMode = 22, 23)
- **手镯** (StdMode = 26)
- **头盔** (StdMode = 15, 16)
- **护身符** (StdMode = 25) - 道士专用
- **腰带** (StdMode = 54)
- **靴子** (StdMode = 52)
- **宝石** (StdMode = 64)

**盾牌/副手（StdMode = 30, 31）:**
- 盾牌（增加AC）
- 火把（照明）

### 3.3 物品属性详解

**攻击属性（DWord格式 - 最小/最大范围）:**
```pascal
// DC（物理攻击力）
MinDC = LoWord(DC)  // 最小物理攻击
MaxDC = HiWord(DC)  // 最大物理攻击

// MC（魔法攻击力）
MinMC = LoWord(MC)  // 最小魔法攻击
MaxMC = HiWord(MC)  // 最大魔法攻击

// SC（精神攻击力）
MinSC = LoWord(SC)  // 最小精神攻击
MaxSC = HiWord(SC)  // 最大精神攻击
```

**防御属性:**
```pascal
// AC（物理防御）
MinAC = LoWord(AC)  // 最小物理防御
MaxAC = HiWord(AC)  // 最大物理防御

// MAC（魔法防御）
MinMAC = LoWord(MAC)  // 最小魔法防御
MaxMAC = HiWord(MAC)  // 最大魔法防御
```

**其他属性:**
- **Weight**: 物品重量,影响总负重
- **Looks**: WIL图像库中的图形索引
- **Source**: 神圣值（正值=神圣,负值=诅咒）
- **AniCount**: 物品图标动画帧数

---

## 4. 物品强化系统

### 4.1 随机附加值系统

物品可以拥有随机属性加成,存储在`btValue`数组中。这些加成在物品生成时随机产生。

**加成来源:**
1. **怪物掉落**: 使用`nMonRandomAddValue`配置
2. **制作物品**: 使用`nMakeRandomAddValue`配置

### 4.2 武器强化配置

武器可以获得DC/MC/SC属性加成。

| 属性 | 最大值配置 | 概率配置 | 描述 |
|------|-----------|---------|------|
| DC | nWeaponDCAddValueMaxLimit | nWeaponDCAddValueRate | 物理攻击加成上限和概率 |
| MC | nWeaponMCAddValueMaxLimit | nWeaponMCAddValueRate | 魔法攻击加成上限和概率 |
| SC | nWeaponSCAddValueMaxLimit | nWeaponSCAddValueRate | 精神攻击加成上限和概率 |

**强化计算示例:**
```pascal
// 武器DC强化
if Random(100) < nWeaponDCAddValueRate then
  nDCBonus = Random(nWeaponDCAddValueMaxLimit) + 1
  WeaponDC += nDCBonus
```

### 4.3 护甲强化配置

护甲可以获得DC/MC/SC/AC/MAC属性加成。

| 属性 | 最大值配置 | 概率配置 |
|------|-----------|---------|
| DC | nDressDCAddValueMaxLimit | nDressDCAddValueRate |
| MC | nDressMCAddValueMaxLimit | nDressMCAddValueRate |
| SC | nDressSCAddValueMaxLimit | nDressSCAddValueRate |
| AC | nDressACAddValueMaxLimit | nDressACAddValueRate |
| MAC | nDressMACAddValueMaxLimit | nDressMACAddValueRate |

### 4.4 饰品强化配置

不同类型的饰品有各自的强化配置。

**项链强化（Shape 19）:**
- DC/MC/SC/AC/MAC加成
- 配置: `nNeckLace19DCAddValueMaxLimit`, `nNeckLace19DCAddRate`等

**项链强化（Shape 20/21/24）:**
- DC/MC/SC加成
- 配置: `nNeckLace20DCAddValueMaxLimit`, `nNeckLace20DCAddRate`等

**戒指强化（Shape 23）:**
- DC/MC/SC加成
- 配置: `nRing23DCAddValueMaxLimit`, `nRing23DCAddRate`等

**手镯强化（Shape 26）:**
- DC/MC/SC加成
- 配置: `nArmRing26DCAddValueMaxLimit`, `nArmRing26DCAddValueRate`等

**头盔强化:**
- DC/MC/SC/AC/MAC加成
- 配置: `nHelmetDCAddValueMaxLimit`, `nHelmetDCAddValueRate`等

### 4.5 未鉴定物品强化

需要鉴定的物品（NeedIdentify = 1）有特殊的强化配置。

**未知戒指:**
- `nUnknowRingDCAddValueMaxLimit` / `nUnknowRingDCAddRate`
- `nUnknowRingMCAddValueMaxLimit` / `nUnknowRingMCAddRate`
- `nUnknowRingSCAddValueMaxLimit` / `nUnknowRingSCAddRate`
- `nUnknowRingACAddValueMaxLimit` / `nUnknowRingACAddRate`
- `nUnknowRingMACAddValueMaxLimit` / `nUnknowRingMACAddRate`

**未知项链和头盔:**
- 类似的配置参数
- 鉴定后才能看到完整属性

### 4.6 强化应用公式

```pascal
// 随机加成生成
if Random(100) < AddValueRate then
  nBonus = Random(AddValueMaxLimit) + 1
  ItemStat += nBonus

// 示例：武器DC强化
// 假设 nWeaponDCAddValueMaxLimit = 10, nWeaponDCAddValueRate = 50
if Random(100) < 50 then  // 50%概率
  nDCBonus = Random(10) + 1  // 1-10点加成
  WeaponDC += nDCBonus
```

---

## 5. 耐久度与修理系统

### 5.1 耐久度机制

**耐久度字段:**
- **Dura**: 当前耐久度
- **DuraMax**: 最大耐久度

**耐久度消耗:**
- 战斗中使用武器/护甲会消耗耐久度
- 施放技能消耗武器耐久度
- 受到攻击消耗护甲耐久度

**耐久度为0的影响:**
- 物品变为不可用状态
- 武器无法攻击
- 护甲不提供防御
- 物品不会消失,可以修理恢复

### 5.2 修理系统配置

| 配置项 | 默认值 | 描述 |
|--------|--------|------|
| nSuperRepairPriceRate | 3 | 特殊修理价格倍数（3倍） |
| nRepairItemDecDura | 3 | 普通修理减少的最大耐久度 |
| RepairDoorPrice | 2,000,000 | 城堡大门修理费用 |
| RepairWallPrice | 可变 | 城堡城墙修理费用 |

### 5.3 修理类型

**1. 普通修理:**
- 恢复当前耐久度（Dura）到最大值
- 但会永久降低最大耐久度（DuraMax）
- 每次普通修理减少`nRepairItemDecDura`点最大耐久（默认3点）
- 费用较低

**2. 特殊修理:**
- 恢复当前耐久度到最大值
- 不降低最大耐久度
- 费用是普通修理的`nSuperRepairPriceRate`倍（默认3倍）
- 推荐用于高价值装备

### 5.4 修理费用计算

```pascal
// 普通修理费用
nRepairCost = (DuraMax - Dura) * ItemPrice / DuraMax

// 特殊修理费用
nSpecialRepairCost = nRepairCost * nSuperRepairPriceRate

// 示例：
// 物品价格 = 10,000金币
// 当前耐久 = 20/100
// 普通修理费 = (100 - 20) * 10000 / 100 = 8,000金币
// 特殊修理费 = 8,000 * 3 = 24,000金币
```

### 5.5 修理相关消息

```pascal
CM_USERREPAIRITEM (1023)          // 请求修理物品
CM_MERCHANTQUERYREPAIRCOST (1024) // 查询修理费用
```

### 5.6 城堡建筑修理

**城堡大门修理:**
- 固定费用: `RepairDoorPrice`（默认2,000,000金币）
- 只有城主或特定权限成员可以修理

**城堡城墙修理:**
- 费用: `RepairWallPrice`（可配置）
- 用于攻城战后的建筑修复

---

## 6. 特殊装备效果

### 6.1 特殊戒指

游戏中存在多种具有特殊效果的戒指,装备后触发特定能力。

| 戒指名称 | 效果描述 | 触发条件 |
|---------|---------|---------|
| 火焰戒指 | 物理攻击附加火焰伤害 | 攻击时触发 |
| 复活戒指 | 死亡时自动复活 | 死亡时触发（消耗耐久） |
| 传送戒指 | 随机传送到附近位置 | 主动使用 |
| 麻痹戒指 | 攻击有概率麻痹敌人 | 攻击时触发 |
| 防护戒指 | 减少受到的伤害 | 被攻击时触发 |
| 隐身戒指 | 使角色进入隐身状态 | 主动使用 |

**火焰戒指（火焰戒指）:**
- 攻击时附加火焰伤害
- 伤害类型: `CM_FIREHIT (3025)`
- 额外伤害基于戒指等级

**复活戒指（复活戒指）:**
- 死亡时自动复活在原地
- 每次复活消耗一定耐久度
- 耐久度为0时失效

**传送戒指（传送戒指）:**
- 随机传送到附近安全位置
- 有冷却时间
- 可用于逃生

**麻痹戒指（麻痹戒指）:**
- 攻击时有概率麻痹目标
- 麻痹持续时间可配置
- 对玩家和怪物都有效

**防护戒指（防护戒指）:**
- 减少受到的物理/魔法伤害
- 减伤比例可配置
- 持续消耗耐久度

**隐身戒指（隐身戒指）:**
- 使角色进入隐身状态
- 怪物无法主动攻击
- 移动或攻击会解除隐身

### 6.2 装备绑定系统

物品可以被绑定,防止交易或丢弃。

**绑定类型:**
1. **账号绑定**: 物品绑定到账号,同账号角色可共享
2. **角色绑定**: 物品绑定到特定角色,无法交易或丢弃

**绑定标志:**
```pascal
// btValue[7] - 绑定状态标志
// Reserved字段位标志:
Reserved & 2  // 无法脱下（需要解锁）
Reserved & 4  // 永久绑定（无法移除）
```

**绑定检查函数:**
```pascal
// 检查物品是否可以使用/装备
function CheckItemBindUse(UserItem: pTUserItem): Boolean
  - 验证账号绑定
  - 检查角色绑定
  - 验证绑定限制
  - 返回是否可以使用
```

**解锁系统:**
- `m_boUserUnLockDurg`: 临时解锁标志
- 允许玩家在特定条件下解除绑定
- 可能需要消耗特殊道具或金币

### 6.3 装备操作函数

```pascal
// 装备物品到槽位
function ClientTakeOnItems(nWhere: Integer; UserItem: TUserItem): Boolean
  - 验证槽位有效性
  - 检查物品类型匹配
  - 验证职业/等级/属性要求
  - 执行装备操作
  - 更新角色属性

// 卸下装备
function ClientTakeOffItems(nWhere: Integer): Boolean
  - 检查槽位是否有物品
  - 验证是否可以卸下（绑定检查）
  - 检查背包空间
  - 执行卸下操作
  - 更新角色属性
```

---

## 7. 背包与仓库系统

### 7.1 背包系统

**背包容量:**
```pascal
MAXBAGITEM = 46  // 最大46个物品槽位
TBagItems = Array[0..45] of TUserItem
```

**背包操作:**
```pascal
// 添加物品到背包
function AddItemToBag(UserItem: TUserItem): Boolean
  - 查找第一个空槽位
  - 检查重量限制
  - 检查是否可堆叠
  - 添加物品到槽位
  - 返回是否成功

// 从背包删除物品
function DelBagItem(nIndex: Integer): Boolean
  - 验证索引有效性
  - 移除指定槽位的物品
  - 更新背包状态

// 查找物品
function FindItemInBag(ItemName: String): Integer
  - 遍历背包槽位
  - 匹配物品名称或索引
  - 返回槽位索引（-1表示未找到）
```

### 7.2 物品拾取与丢弃

**物品拾取:**
```pascal
// 拾取消息
CM_PICKUP (1001)

// 拾取验证:
- 检查背包是否有空位
- 检查重量是否超限
- 检查物品所有权（是否可以拾取）
- 检查距离（是否在拾取范围内）
```

**物品丢弃:**
```pascal
// 丢弃消息
CM_DROPITEM (1000)

// 丢弃控制配置:
CheckBoxControlDropItem      // 启用丢弃物品控制
EditCanDropPrice            // 最低可丢弃物品价格（默认10金币）
EditCanDropGold             // 最低可丢弃金币数量（默认10）
CheckBoxLockDropItem        // 锁定丢弃（启用时禁止丢弃）
```

**死亡掉落:**
```pascal
// 死亡掉落配置:
CheckBoxKillByHumanDropUseItem  // 被玩家杀死时掉落装备
CheckBoxDieScatterBag           // 死亡时掉落背包物品
CheckBoxDieDropGold             // 死亡时掉落金币

// 掉落率受以下因素影响:
- PK值（红名掉落率更高）
- 服务器配置
- 特殊保护状态
```

### 7.3 重量与负重系统

**重量数据结构:**
```pascal
TAbility = packed record
  Weight: Word;      // 当前总重量
  MaxWeight: Word;   // 最大负重
  WearWeight: Word;  // 装备重量
  HandWeight: Word;  // 武器重量
end;
```

**重量计算:**
```pascal
// 总重量 = 背包重量 + 装备重量
TotalWeight = BagWeight + WearWeight + HandWeight

// 最大负重基于力量和等级
MaxWeight = BaseWeight + (Strength * WeightPerStr) + (Level * WeightPerLevel)

// 超重惩罚
if Weight > MaxWeight then
  MovementSpeed = Reduced      // 移动速度降低
  CannotPickup = True          // 无法拾取新物品
```

**负重状态:**
- **正常**: `Weight <= MaxWeight` - 正常移动速度
- **超重**: `Weight > MaxWeight` - 移动速度降低50%
- **严重超重**: `Weight >= MaxWeight * 1.5` - 无法移动

### 7.4 仓库系统

**仓库容量:**
```pascal
TStorageItems = Array[0..39] of TUserItem  // 40个仓库槽位
```

**仓库操作:**
```pascal
// 存入物品
CM_USERSTORAGEITEM (1031)
  - 从背包移动物品到仓库
  - 检查仓库空位
  - 验证物品可存储性（绑定物品检查）

// 取出物品
CM_USERTAKEBACKSTORAGEITEM (1032)
  - 从仓库移动物品到背包
  - 检查背包空位
  - 检查重量限制
```

**仓库特性:**
- **安全存储**: 物品不会丢失或被盗
- **共享仓库**: 可配置账号共享（同账号角色共用）
- **容量固定**: 40个槽位,不可扩展
- **访问限制**: 只能在城镇仓库NPC处访问
- **存储费用**: 可能需要支付金币（可配置）

### 7.5 银行系统

**银行引擎（TBankEngine）:**
```pascal
// 操作类型
TOpAction = (o_GetGold, o_SaveGold, o_ViewGold)

// 请求信息
TReQuestInfo = record
  NPC: TMerchant;           // 银行NPC
  PlayObject: TPlayObject;  // 玩家对象
  OpAction: TOpAction;      // 操作类型
  nGameGold: Integer;       // 金币数量
  sAccount: String;         // 账号
  sPassword: String;        // 密码
end;
```

**银行操作:**
1. **存款（o_SaveGold）**: 将金币存入银行
2. **取款（o_GetGold）**: 从银行取出金币
3. **查询（o_ViewGold）**: 查看银行余额

**银行特性:**
- **密码保护**: 账号需要密码才能访问
- **线程安全**: 使用临界区保护并发访问
- **无限容量**: 金币存储无上限
- **利息系统**: 可配置存款利息（如果实现）

---

## 8. 物品交易系统

### 8.1 玩家间交易

**交易消息:**
```pascal
CM_DEALITEM (1009)      // 发起/管理交易
CM_DEALTRY (1010)       // 请求与其他玩家交易
CM_DEALADDITEM (1011)   // 添加物品到交易窗口
CM_DEALDELITEM (1012)   // 从交易窗口移除物品
```

**交易流程:**
1. **发起交易**: 玩家A向玩家B发送交易请求（`CM_DEALTRY`）
2. **接受请求**: 玩家B接受交易请求
3. **添加物品**: 双方添加物品和金币到交易窗口
4. **确认交易**: 双方确认交易内容
5. **服务器验证**: 服务器验证交易合法性
6. **执行交易**: 物品和金币交换完成

**交易限制:**
```pascal
// 交易控制配置
CheckBoxLockDealItem  // 锁定交易（启用时禁止交易）

// 交易限制检查:
- 绑定物品无法交易
- 玩家必须在交易范围内（通常3-5格）
- 只能在安全区域交易（城镇）
- 双方必须都确认才能完成交易
- 背包必须有足够空位接收物品
```

**防诈骗机制:**
- 双方确认机制（两次确认）
- 交易窗口显示完整物品信息
- 服务器端验证所有交易操作
- 交易记录日志

### 8.2 NPC商人系统

**商人操作消息:**
```pascal
CM_USERBUYITEM (1014)              // 从NPC购买物品
CM_USERSELLITEM (1013)             // 向NPC出售物品
CM_MERCHANTQUERYSELLPRICE (1012)   // 查询出售价格
CM_USERGETDETAILITEM (1015)        // 查看物品详细信息
```

**商人配置:**
```pascal
// NPC商人设置
EditPriceRate: TSpinEdit  // 买卖价格比率（60-500%）
  - 默认值: 60（玩家出售物品获得60%价值）
  - 范围: 60% 到 500%
  - 影响买入和卖出价格

CheckBoxS_repair: TCheckBox   // 启用修理服务
CheckBoxSendMsg: TCheckBox    // 发送问候消息
```

**价格计算公式:**
```pascal
// 出售价格（玩家卖给NPC）
nSellPrice = ItemPrice * (PriceRate / 100)

// 购买价格（玩家从NPC购买）
nBuyPrice = ItemPrice * (100 / PriceRate)

// 城堡成员折扣
if PlayerInCastleGuild then
  nBuyPrice = nBuyPrice * (CastleMemberPriceRate / 100)

// 示例:
// 物品基础价格 = 10,000金币
// PriceRate = 60
// 玩家出售价 = 10,000 * 0.6 = 6,000金币
// 玩家购买价 = 10,000 * (100/60) = 16,667金币
```

**城堡成员定价:**
```pascal
EditCastleMemberPriceRate  // 城堡成员折扣率
  - 默认值: 10（90%价格，即10%折扣）
  - 适用于拥有城堡的行会成员
  - 可按城堡单独配置
```

### 8.3 物品堆叠系统

**可堆叠物品:**
- 消耗品（药水、卷轴等）可以堆叠
- 最大堆叠数量因物品类型而异
- 堆叠数量存储在`Dura`字段中（消耗品）
- 装备类物品不可堆叠

**堆叠规则:**
```pascal
// 检查物品是否可以堆叠
function CanItemStack(Item1, Item2: pTUserItem): Boolean
  - 相同的wIndex（物品类型）
  - 相同的物品属性
  - 不是装备（武器/护甲不堆叠）
  - 堆叠数量 < 最大堆叠数
  - 返回是否可以堆叠

// 合并堆叠
function Overlap(SourceItem, TargetItem: pTUserItem): Boolean
  - 合并堆叠数量
  - 如果完全合并则移除源物品
  - 更新目标堆叠数量
  - 返回是否成功合并
```

**堆叠示例:**
```pascal
// 药水堆叠
// 假设最大堆叠数 = 100
// 槽位1: 金创药(小) x 60
// 槽位2: 金创药(小) x 50
// 合并后: 槽位1: 金创药(小) x 100, 槽位2: 金创药(小) x 10
```

---

## 9. 物品掉落系统

### 9.1 怪物掉落配置

**掉落参数:**
```pascal
EditMonOneDropGoldCount  // 每只怪物基础金币掉落数量
nMonRandomAddValue       // 怪物掉落物品随机加成值
EditCanDropPrice         // 最低可掉落物品价格（低于此价格的物品被销毁）
EditCanDropGold          // 最低可掉落金币数量
```

### 9.2 掉落机制

**物品掉落函数:**
```pascal
// 掉落物品到地面
function DropItemDown(UserItem: pTUserItem; nX, nY: Integer): Boolean
  - 验证掉落位置合法性
  - 检查物品价格是否 >= EditCanDropPrice
  - 应用随机加成（nMonRandomAddValue）
  - 将物品放置在指定坐标
  - 设置物品所有权计时器
  - 返回是否成功掉落

// 怪物战利品生成
function MakeItem(MonsterLevel, ItemType: Integer): pTUserItem
  - 根据怪物等级生成物品
  - 应用随机加成（nMakeRandomAddValue）
  - 计算物品属性和耐久度
  - 返回生成的物品
```

### 9.3 掉落控制标志

```pascal
CheckBoxControlDropItem           // 启用掉落物品控制
CheckBoxKillByHumanDropUseItem   // 被玩家杀死时掉落装备
CheckBoxDieScatterBag            // 死亡时掉落背包物品
CheckBoxDieDropGold              // 死亡时掉落金币
CheckBoxLockDropItem             // 锁定掉落（禁止丢弃物品）
```

**掉落控制逻辑:**
```pascal
// 物品掉落检查
if CheckBoxControlDropItem then
  if ItemPrice < EditCanDropPrice then
    // 物品价格太低，不掉落（直接销毁）
    return False

// 金币掉落检查
if GoldAmount < EditCanDropGold then
  // 金币数量太少，不掉落
  return False

// 死亡掉落检查
if KilledByPlayer and CheckBoxKillByHumanDropUseItem then
  // 掉落装备物品
  DropEquippedItems()

if CheckBoxDieScatterBag then
  // 掉落背包物品
  DropBagItems()

if CheckBoxDieDropGold then
  // 掉落金币
  DropGold()
```

### 9.4 物品所有权系统

**所有权机制:**
- 掉落的物品有临时所有权（首次拾取权）
- 所有权在一定时间后过期
- 队伍成员可能共享所有权
- 行会成员可能有优先拾取权

**所有权计时器:**
```pascal
// 物品所有权时间
ItemOwnershipTime = 30秒  // 默认30秒后所有权过期

// 所有权检查
if CurrentTime < Item.OwnershipExpireTime then
  if Player != Item.Owner and not InSameParty(Player, Item.Owner) then
    // 无法拾取，不是所有者或队友
    return False
```

### 9.5 掉落率计算

**掉落率影响因素:**
1. **怪物等级**: 高等级怪物掉落更好的物品
2. **玩家幸运值**: 幸运值影响掉落品质
3. **服务器倍率**: 服务器配置的掉落倍率
4. **特殊事件**: 双倍掉落活动等

**掉落品质:**
```pascal
// 物品品质受以下因素影响:
- nMonRandomAddValue: 随机加成基础值
- 玩家幸运值: 影响加成概率
- 怪物等级: 影响物品等级范围
- 特殊掉落表: 稀有物品掉落配置
```

---

## 10. 物品制作与合成

### 10.1 制作系统

**制作操作:**
```pascal
CM_USERMAKEDRUGITEM (1034)  // 制作药品/消耗品
```

**制作流程:**
1. **选择配方**: 玩家选择要制作的物品配方
2. **检查材料**: 验证背包中是否有所需材料
3. **消耗材料**: 从背包中移除制作材料
4. **成功判定**: 根据成功率判定是否制作成功
5. **生成物品**: 成功则生成物品，失败则材料消失
6. **获得经验**: 制作可能获得经验值

**制作配置:**
```pascal
nMakeRandomAddValue  // 制作物品随机加成值
  - 影响制作物品的属性加成
  - 数值越高，制作物品属性越好
```

### 10.2 制作成功率

**成功率因素:**
- 玩家等级
- 制作技能等级（如果有）
- 配方难度
- 材料品质

**失败惩罚:**
- 制作失败时材料消失
- 不返还任何物品
- 可能获得少量经验

### 10.3 特殊物品合成

**护身符制作（道士）:**
- 道士可以制作各种护身符
- 需要特定材料和符纸
- 成功率基于道士等级和SC属性

**药品制作:**
- 制作各种恢复药水
- 需要药材和空瓶
- 成功率基于制作技能

**装备强化:**
- 使用强化石提升装备属性
- 有成功率和失败风险
- 失败可能导致装备损坏或属性降低

### 10.4 制作配方系统

**配方结构:**
```pascal
TRecipe = record
  RecipeName: String;           // 配方名称
  ResultItem: Integer;          // 结果物品索引
  ResultCount: Integer;         // 结果物品数量
  Materials: Array of TMaterial; // 所需材料列表
  SuccessRate: Integer;         // 成功率（0-100）
  RequiredLevel: Integer;       // 需求等级
  RequiredSkill: Integer;       // 需求技能等级
end;

TMaterial = record
  ItemIndex: Integer;   // 材料物品索引
  Count: Integer;       // 所需数量
end;
```

**配方示例:**
```pascal
// 金创药(中)配方
Recipe_MediumHealingPotion = {
  RecipeName: "金创药(中)",
  ResultItem: 1002,      // 金创药(中)索引
  ResultCount: 1,
  Materials: [
    {ItemIndex: 2001, Count: 2},  // 草药 x2
    {ItemIndex: 2002, Count: 1}   // 空瓶 x1
  ],
  SuccessRate: 80,       // 80%成功率
  RequiredLevel: 10,
  RequiredSkill: 0
}
```

---

## 11. 总结

### 11.1 装备与物品系统核心特性

**装备系统:**
- 13个装备槽位，支持全身装备
- 职业、等级、属性限制确保平衡性
- 装备绑定系统防止物品流失
- 特殊装备效果增加游戏深度

**物品系统:**
- 完善的物品数据结构（TStdItem, TUserItem）
- 丰富的物品类型和属性
- 随机属性加成系统增加物品多样性
- 耐久度和修理系统增加经济循环

**存储系统:**
- 46槽位背包 + 40槽位仓库
- 重量负重系统限制携带能力
- 银行系统安全存储金币
- 物品堆叠优化存储空间

**交易系统:**
- 玩家间安全交易机制
- NPC商人买卖系统
- 灵活的价格配置
- 城堡成员优惠

**掉落系统:**
- 怪物掉落配置灵活
- 物品所有权保护
- 死亡惩罚可配置
- 掉落品质受多因素影响

**制作系统:**
- 配方制作系统
- 成功率机制
- 材料消耗
- 随机属性加成

### 11.2 系统间的关联

```
装备系统 ←→ 物品系统
    ↓           ↓
  绑定系统   强化系统
    ↓           ↓
  交易系统   掉落系统
    ↓           ↓
  背包系统   制作系统
    ↓           ↓
  仓库系统   修理系统
```

### 11.3 配置参数速查表

| 参数类别 | 关键配置 | 默认值 |
|---------|---------|--------|
| 背包容量 | MAXBAGITEM | 46 |
| 仓库容量 | TStorageItems | 40 |
| 装备槽位 | THumanUseItems | 13 |
| 普通修理耐久损失 | nRepairItemDecDura | 3 |
| 特殊修理价格倍数 | nSuperRepairPriceRate | 3 |
| NPC价格比率 | EditPriceRate | 60% |
| 城堡成员折扣 | EditCastleMemberPriceRate | 10% |
| 最低掉落价格 | EditCanDropPrice | 10 |
| 最低掉落金币 | EditCanDropGold | 10 |
| 怪物掉落加成 | nMonRandomAddValue | 可配置 |
| 制作物品加成 | nMakeRandomAddValue | 可配置 |

### 11.4 数据结构大小

| 结构名 | 大小 | 用途 |
|--------|------|------|
| TStdItem | 60字节 | 物品模板定义 |
| TUserItem | 24字节 | 物品实例 |
| TBagItems | 1,104字节 | 背包（46 x 24） |
| TStorageItems | 960字节 | 仓库（40 x 24） |
| THumanUseItems | 312字节 | 装备（13 x 24） |

---

## 12. 版本信息

**文档版本**: 1.0
**创建日期**: 2025-10-18
**基于代码版本**: 20020522
**分析文件**:
- `Source/Common/Grobal2.pas` - 数据结构定义
- `Source/EM2Engine/ObjBase.pas` - 物品操作函数
- `Source/EM2Engine/ItemSet.pas` - 物品配置
- `Source/EM2Engine/GameConfig.dfm` - 游戏配置
- `Source/EM2Engine/ConfigMerchant.dfm` - 商人配置
- `Source/EM2Engine/BnkEngn.pas` - 银行系统

**文档说明**:
本文档完全基于实际代码库分析，所有数据结构、函数签名、配置参数和计算公式均来自源代码。文档旨在为开发者、游戏设计师和玩家提供详细的技术参考。

---

**© 2025 GameOfMir翎风项目 - 装备与物品系统详解**


