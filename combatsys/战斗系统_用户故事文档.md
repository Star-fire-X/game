# mir2 战斗系统用户故事文档

> 文档版本: 1.0
> 生成日期: 2026-01-30
> 基于代码分析自动生成

---

## 一、项目战斗系统概览

### 1.1 项目基本信息

| 属性 | 描述 |
|------|------|
| 项目名称 | 传奇2 (Legend of Mir 2) |
| 编程语言 | Object Pascal (Delphi) |
| 代码规模 | 约 40,000+ 行代码 |
| 架构模式 | 7层分层架构 + 多线程设计 |
| 版本标识 | MIR2EI (扩展版本) |

### 1.2 战斗系统核心文件

| 文件路径 | 功能描述 | 代码行数 |
|----------|----------|----------|
| `Source/M2Server/ObjBase.pas` | 对象基类系统，包含TCreature、TAnimal、TUserHuman | ~611KB |
| `Source/M2Server/ObjMon.pas` | 怪物系统，28种怪物类型定义和AI逻辑 | ~71KB |
| `Source/M2Server/ObjMon2.pas` | 怪物系统扩展，特殊怪物类型 | ~66KB |
| `Source/M2Server/Magic.pas` | 魔法管理系统，技能施放和效果处理 | ~50KB |
| `Source/M2Server/UsrEngn.pas` | 用户引擎，玩家命令和游戏逻辑 | ~120KB |
| `Source/M2Server/itmunit.pas` | 物品升级单元，装备属性生成 | - |
| `Source/Common/Grobal2.pas` | 全局常量和数据结构定义 | - |

### 1.3 功能架构图（文字描述）

```
┌─────────────────────────────────────────────────────────────────┐
│                        战斗系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  客户端层   │  │  网关层     │  │  服务器层   │             │
│  │ PlayScn.pas │──│ RunGate     │──│ M2Server    │             │
│  │ Actor.pas   │  │ SelGate     │  │ UsrEngn.pas │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
├─────────────────────────────────────────────────────────────────┤
│                        核心战斗模块                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    TCreature (生物基类)                  │   │
│  │  ├── TAnimal (动物类)                                   │   │
│  │  │   ├── TUserHuman (玩家类)                            │   │
│  │  │   ├── TMonster (怪物基类)                            │   │
│  │  │   │   ├── TATMonster (攻击型)                        │   │
│  │  │   │   ├── TSpitSpider (远程型)                       │   │
│  │  │   │   ├── TCowKingMonster (BOSS型)                   │   │
│  │  │   │   └── ... (28种怪物类型)                         │   │
│  │  │   └── TNormNpc (NPC基类)                             │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                        支撑系统                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ 魔法系统 │ │ 物品系统 │ │ 状态系统 │ │ PK系统   │          │
│  │Magic.pas │ │itmunit   │ │StatusArr │ │PKHiter   │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、核心数据结构

### 2.1 能力值系统

**TAbility - 角色能力值**
```pascal
record
  Level: byte;           // 角色等级
  AC: word;              // 物理防御力 (Armor Class)
  DC: word;              // 物理攻击力 (Damage Class) - MakeWord(min,max)格式
  HP, MP: word;          // 当前生命/魔法值
  MaxHP, MaxMP: word;    // 最大生命/魔法值
  Exp, MaxExp: longword; // 经验值
  Weight, MaxWeight: word; // 负重
end;
```

**TAddAbility - 附加能力值**
```pascal
record
  HP, MP: word;          // 生命/魔法加成
  HIT, SPEED: word;      // 命中/速度加成
  AC, DC: word;          // 防御/攻击加成
  AntiPoison: word;      // 抗毒能力(%)
  HealthRecover: word;   // 生命恢复速度(%)
  AntiMagic: word;       // 魔法闪避率(%)
  Luck: byte;            // 幸运值
  UnLuck: byte;          // 诅咒值
  HitSpeed: shortint;    // 攻击速度加成
  UndeadPower: byte;     // 对亡灵攻击力
end;
```

### 2.2 伤害计算公式

**物理伤害计算** (`GetHitStruckDamage`)
```
实际伤害 = MAX(0, 原始伤害 - 随机防御)
随机防御 = AC最小值 + Random(AC最大值 - AC最小值 + 1)
亡灵额外伤害 = 攻击者.UndeadPower
```

**魔法伤害计算** (`GetMagStruckDamage`)
```
实际伤害 = MAX(0, 原始伤害 - 随机魔防)
随机魔防 = MAC最小值 + Random(MAC最大值 - MAC最小值 + 1)
```

**魔法威力计算** (`MPow`)
```
威力 = 最小威力 + Random(最大威力 - 最小威力)
```

---

## 三、Epic 级别用户故事

### Epic 1: 基础战斗流程

**描述**: 实现玩家与怪物之间的基础战斗交互，包括普通攻击、受击反馈、死亡处理等核心流程。

**涉及文件**:
- [ObjBase.pas](Source/M2Server/ObjBase.pas) - `_Attack`, `HitHit`, `StruckDamage`
- [ObjMon.pas](Source/M2Server/ObjMon.pas) - `AttackTarget`, `Run`

**现有功能**: ✅ 已实现

---

### Epic 2: 技能系统

**描述**: 实现战士剑术技能和法师/道士魔法技能的施放、效果计算和冷却管理。

**涉及文件**:
- [Magic.pas](Source/M2Server/Magic.pas) - `SpellNow`, `MPow`, `IsSwordSkill`
- [ObjBase.pas](Source/M2Server/ObjBase.pas) - `DoSpell`, `GetMagic`

**剑术技能ID**:
| ID | 技能名称 | 描述 |
|----|----------|------|
| 3 | 攻杀剑术 | 基础剑法 |
| 4 | 刺杀剑术 | 穿刺攻击 |
| 7 | 半月弯刀 | 范围攻击 |
| 12 | 烈火剑法 | 火焰附加 |
| 25 | 莲月剑法 | 连击技能 |
| 26 | 开天斩 | 强力单体 |
| 27 | 逐日剑法 | 远程剑气 |

**现有功能**: ✅ 已实现

---

### Epic 3: 伤害计算系统

**描述**: 实现物理伤害和魔法伤害的计算，包括防御减免、属性加成、暴击等机制。

**涉及文件**:
- [ObjBase.pas:3980](Source/M2Server/ObjBase.pas#L3980) - `GetHitStruckDamage`
- [ObjBase.pas](Source/M2Server/ObjBase.pas) - `GetMagStruckDamage`

**现有功能**: ✅ 已实现

---

### Epic 4: 战斗状态管理

**描述**: 管理战斗中的各种状态效果，包括中毒、定身、隐身、疯狂等。

**涉及文件**:
- [ObjBase.pas](Source/M2Server/ObjBase.pas) - `StatusArr`, `MakeHolySeize`, `MakeCrazyMode`

**现有功能**: ✅ 已实现

---

### Epic 5: 战斗奖励系统

**描述**: 处理战斗胜利后的经验值分配、物品掉落和金币奖励。

**涉及文件**:
- [ObjBase.pas](Source/M2Server/ObjBase.pas) - `CalcGetExp`, `GainExp`

**现有功能**: ✅ 已实现

---

## 四、具体用户故事

### US-001: 玩家普通攻击

**作为** 玩家
**我想要** 对目标怪物进行普通物理攻击
**以便** 造成伤害并击杀怪物获得奖励

**验收标准**:
- [x] 点击攻击或按快捷键可发起攻击
- [x] 攻击距离限制为1格（近战）
- [x] 攻击有冷却时间限制
- [x] 攻击命中后播放受击动画

**技术实现要点**:
- 文件: [ObjBase.pas](Source/M2Server/ObjBase.pas) - `_Attack`, `HitHit`
- 伤害公式: `DC最小值 + Random(DC最大值 - DC最小值)`

**优先级**: P0 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-002: 怪物AI攻击

**作为** 游戏系统
**我想要** 怪物能够自动寻找并攻击玩家
**以便** 提供战斗挑战

**验收标准**:
- [x] 怪物在视野范围内发现玩家后主动攻击
- [x] 不同怪物有不同的攻击模式
- [x] 怪物攻击有冷却时间

**技术实现要点**:
- 文件: [ObjMon.pas](Source/M2Server/ObjMon.pas) - `AttackTarget`, `Run`
- AI类型: TATMonster(主动), TChickenDeer(逃跑)

**优先级**: P0 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-003: 物理伤害计算

**作为** 游戏系统
**我想要** 根据攻防属性计算实际伤害
**以便** 实现平衡的战斗数值

**验收标准**:
- [x] 伤害 = 攻击力 - 防御力（随机范围）
- [x] 伤害最小为0
- [x] 对亡灵类怪物有额外伤害加成

**技术实现要点**:
- 文件: [ObjBase.pas:3980](Source/M2Server/ObjBase.pas#L3980)
- 函数: `GetHitStruckDamage`

**优先级**: P0 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-004: 魔法伤害计算

**作为** 法师/道士玩家
**我想要** 魔法攻击能够正确计算伤害
**以便** 魔法职业有合理的输出能力

**验收标准**:
- [x] 魔法伤害受魔防(MAC)减免
- [x] 不同魔法有不同的威力范围
- [x] 魔法盾可额外减少伤害

**技术实现要点**:
- 文件: [ObjBase.pas](Source/M2Server/ObjBase.pas) - `GetMagStruckDamage`
- 文件: [Magic.pas](Source/M2Server/Magic.pas) - `MPow`

**优先级**: P0 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-005: 剑术技能触发

**作为** 战士玩家
**我想要** 在普通攻击时触发剑术技能
**以便** 提升战斗输出

**验收标准**:
- [x] 攻杀剑术(ID:3)可在攻击时触发
- [x] 刺杀剑术(ID:4)可穿透攻击
- [x] 半月弯刀(ID:7)可范围攻击
- [x] 烈火剑法(ID:12)附加火焰伤害

**技术实现要点**:
- 文件: [Magic.pas:91](Source/M2Server/Magic.pas#L91) - `IsSwordSkill`

**优先级**: P0 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-006: 魔法技能施放

**作为** 法师/道士玩家
**我想要** 施放各种魔法技能
**以便** 进行远程攻击或辅助

**验收标准**:
- [x] 检查MP是否足够
- [x] 检查技能冷却时间
- [x] 施放后扣除MP消耗

**技术实现要点**:
- 文件: [Magic.pas:65](Source/M2Server/Magic.pas#L65) - `SpellNow`

**优先级**: P0 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-007: 召唤兽系统

**作为** 道士玩家
**我想要** 召唤骷髅或神兽协助战斗
**以便** 增强战斗能力

**验收标准**:
- [x] 召唤骷髅(TWhiteSkeleton)
- [x] 召唤神兽(TElfMonster/TElfWarriorMonster)
- [x] 召唤兽有忠诚度时间限制
- [x] 召唤兽可获得经验升级

**技术实现要点**:
- 文件: [ObjMon.pas:192](Source/M2Server/ObjMon.pas#L192) - `TWhiteSkeleton`
- 变量: `SlaveList`, `MasterRoyaltyTime`, `SlaveExp`

**优先级**: P1 | **复杂度**: L | **状态**: ✅ 已实现

---

### US-008: 定身状态效果

**作为** 游戏系统
**我想要** 实现定身(HolySeize)状态效果
**以便** 控制怪物移动

**验收标准**:
- [x] 困魔咒可使怪物定身
- [x] 定身期间无法移动
- [x] 定身有持续时间限制

**技术实现要点**:
- 文件: [ObjBase.pas](Source/M2Server/ObjBase.pas) - `MakeHolySeize`
- 变量: `BoHolySeize`, `HolySeizeTime`

**优先级**: P1 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-009: 中毒状态效果

**作为** 游戏系统
**我想要** 实现中毒状态效果
**以便** 增加战斗策略性

**验收标准**:
- [x] 毒蜘蛛可使目标中毒
- [x] 中毒持续掉血
- [x] 抗毒属性可减少中毒概率

**技术实现要点**:
- 文件: [ObjBase.pas](Source/M2Server/ObjBase.pas)
- 变量: `PoisonLevel`, `AntiPoison`, `PoisonRecover`

**优先级**: P1 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-010: 隐身状态效果

**作为** 道士玩家
**我想要** 使用隐身术隐藏自己
**以便** 躲避怪物攻击

**验收标准**:
- [x] 隐身术使玩家对怪物不可见
- [x] 隐身有持续时间限制
- [x] 攻击或被攻击会解除隐身

**技术实现要点**:
- 文件: [Magic.pas:59](Source/M2Server/Magic.pas#L59) - `MagMakePrivateTransparent`
- 变量: `BoHumHideMode`

**优先级**: P1 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-011: 经验值获取

**作为** 玩家
**我想要** 击杀怪物后获得经验值
**以便** 提升角色等级

**验收标准**:
- [x] 根据怪物等级和HP计算经验
- [x] 组队时经验分配
- [x] 召唤兽也可获得经验

**技术实现要点**:
- 文件: [ObjBase.pas](Source/M2Server/ObjBase.pas) - `CalcGetExp`, `GainExp`

**优先级**: P0 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-012: BOSS怪物机制

**作为** 玩家
**我想要** 挑战具有特殊机制的BOSS怪物
**以便** 获得更好的奖励

**验收标准**:
- [x] 牛魔王可瞬移和暴走
- [x] 祖玛王可召唤小怪
- [x] 骷髅王可远程攻击

**技术实现要点**:
- 文件: [ObjMon.pas:139](Source/M2Server/ObjMon.pas#L139) - `TCowKingMonster`

**优先级**: P1 | **复杂度**: L | **状态**: ✅ 已实现

---

### US-013: PK系统

**作为** 玩家
**我想要** 与其他玩家进行PK战斗
**以便** 体验PVP玩法

**验收标准**:
- [x] 记录先攻击者(PKHiterList)
- [x] PK值累积和惩罚机制
- [x] 红名玩家出生点变更

**技术实现要点**:
- 变量: `PlayerKillingPoint`, `PKHiterList`

**优先级**: P1 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-014: 特殊装备效果

**作为** 玩家
**我想要** 装备特殊戒指获得额外能力
**以便** 增强战斗能力

**验收标准**:
- [x] 隐身戒指(Shape:111)可隐身
- [x] 传送戒指(Shape:112)可传送
- [x] 麻痹戒指(Shape:113)可麻痹敌人
- [x] 复活戒指(Shape:114)可复活

**技术实现要点**:
- 常量: `RING_TRANSPARENT_ITEM`, `RING_SPACEMOVE_ITEM`

**优先级**: P1 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-015: 范围魔法攻击

**作为** 法师玩家
**我想要** 使用范围魔法攻击多个敌人
**以便** 高效清怪

**验收标准**:
- [x] 爆裂火焰造成范围伤害
- [x] 冰咆哮造成范围伤害
- [x] 地狱雷光以自身为中心攻击

**技术实现要点**:
- 文件: [Magic.pas:55](Source/M2Server/Magic.pas#L55) - `MagBigExplosion`

**优先级**: P1 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-016: 野蛮冲撞

**作为** 战士玩家
**我想要** 使用野蛮冲撞推开敌人
**以便** 控制战场位置

**验收标准**:
- [x] 推开周围1格内的敌人
- [x] 根据等级差计算成功率
- [x] 技能等级影响推开距离

**技术实现要点**:
- 文件: [Magic.pas:41](Source/M2Server/Magic.pas#L41) - `MagPushArround`

**优先级**: P2 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-017: 圣言术即死效果

**作为** 道士玩家
**我想要** 对亡灵怪物使用圣言术
**以便** 直接击杀低等级亡灵

**验收标准**:
- [x] 只对亡灵系怪物有效
- [x] 根据等级差计算即死概率
- [x] 未击杀也会使目标逃跑

**技术实现要点**:
- 文件: [Magic.pas:45](Source/M2Server/Magic.pas#L45) - `MagTurnUndead`

**优先级**: P2 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-018: 困魔咒结界

**作为** 法师玩家
**我想要** 使用困魔咒困住怪物
**以便** 控制战场

**验收标准**:
- [x] 在目标位置创建结界
- [x] 结界内怪物无法移动
- [x] 结界有持续时间限制

**技术实现要点**:
- 文件: [Magic.pas:49](Source/M2Server/Magic.pas#L49) - `MagMakeHolyCurtain`

**优先级**: P2 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-019: 火墙技能

**作为** 法师玩家
**我想要** 释放火墙持续伤害敌人
**以便** 进行区域控制

**验收标准**:
- [x] 创建十字形火焰区域
- [x] 火墙持续造成伤害
- [x] 火墙有持续时间限制

**技术实现要点**:
- 文件: [Magic.pas:51](Source/M2Server/Magic.pas#L51) - `MagMakeFireCross`

**优先级**: P2 | **复杂度**: M | **状态**: ✅ 已实现

---

### US-020: 瞬息移动

**作为** 法师玩家
**我想要** 使用瞬息移动传送到安全区
**以便** 快速逃离危险

**验收标准**:
- [x] 根据技能等级计算成功率
- [x] 传送到出生点地图
- [x] 台湾活动用户不能使用

**技术实现要点**:
- 文件: [Magic.pas:47](Source/M2Server/Magic.pas#L47) - `MagLightingSpaceMove`

**优先级**: P2 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-021: 群体治愈术

**作为** 道士玩家
**我想要** 治疗范围内的友方单位
**以便** 支援团队战斗

**验收标准**:
- [x] 治疗范围内所有友方
- [x] 治疗量根据技能等级计算

**技术实现要点**:
- 文件: [Magic.pas:53](Source/M2Server/Magic.pas#L53) - `MagBigHealing`

**优先级**: P2 | **复杂度**: S | **状态**: ✅ 已实现

---

### US-022: 怪物诱惑控制

**作为** 道士玩家
**我想要** 使用噬血术控制怪物
**以便** 将怪物变为召唤兽

**验收标准**:
- [x] 对非玩家目标有效
- [x] 根据等级差计算控制概率
- [x] 可抢夺他人召唤物

**技术实现要点**:
- 文件: [Magic.pas:166](Source/M2Server/Magic.pas#L166) - `MagLightingShock`

**优先级**: P2 | **复杂度**: M | **状态**: ✅ 已实现

---

## 五、边界场景和异常处理

### 5.1 网络延迟/断线场景

| 场景 | 现有处理 | 状态 |
|------|----------|------|
| 攻击延迟 | `SendDelayMsg`延迟消息 | ✅ |
| 断线重连 | 保存角色状态到DB | ✅ |
| 消息队列 | `MsgList`管理 | ✅ |

### 5.2 并发攻击处理

| 场景 | 现有处理 | 状态 |
|------|----------|------|
| 多人同时攻击 | 独立计算伤害 | ✅ |
| 攻击冷却 | `NextHitTime`控制 | ✅ |
| 目标锁定 | `TargetCret`管理 | ✅ |

### 5.3 非法操作防护

| 场景 | 现有处理 | 状态 |
|------|----------|------|
| 非法攻击检测 | `BoIllegalAttack`标志 | ✅ |
| 距离验证 | 攻击前检查距离 | ✅ |
| 防刷机制 | `ANTI_MUKJA_DELAY` | ✅ |

### 5.4 边界值处理

| 场景 | 现有处理 | 状态 |
|------|----------|------|
| HP为0 | `Death`标志+死亡处理 | ✅ |
| 超大伤害 | `_MAX(0, damage)` | ✅ |
| 金币上限 | `MAXGOLD=20亿` | ✅ |
| 等级上限 | `MAXLEVEL-1=49` | ✅ |

---

## 六、非功能性需求

### 6.1 性能要求

| 指标 | 现有实现 |
|------|----------|
| 体力恢复间隔 | 300ms (`HEALTHFILLTICK`) |
| 魔力恢复间隔 | 800ms (`SPELLFILLTICK`) |
| 定时器精度 | 500ms/5s/10s/30s/10min |

### 6.2 安全性要求

| 要求 | 现有实现 |
|------|----------|
| 防作弊 | 服务端伤害计算 |
| 数据校验 | 攻击距离验证 |
| 权限控制 | 管理员密码验证 |

### 6.3 可扩展性考虑

| 扩展点 | 现有设计 |
|--------|----------|
| 怪物类型 | 继承TMonster基类 |
| 魔法技能 | TMagicManager统一管理 |
| 装备效果 | Shape值区分类型 |

---

## 七、技术债务和改进建议

### 7.1 现有技术债务

| 问题 | 描述 | 优先级 |
|------|------|--------|
| 硬编码常量 | 魔法ID、装备Shape等硬编码 | P2 |
| 代码注释 | 部分韩文注释需翻译 | P3 |
| 单元测试 | 缺少自动化测试 | P2 |

### 7.2 改进建议

| 建议 | 描述 | 收益 |
|------|------|------|
| 配置化 | 将硬编码常量移至配置文件 | 易维护 |
| 日志系统 | 增加战斗日志记录 | 易调试 |
| 数据驱动 | 技能/怪物数据表驱动 | 易扩展 |

---

## 八、用户故事统计

| 分类 | 数量 | 状态 |
|------|------|------|
| Epic | 5 | ✅ 全部已实现 |
| User Story | 22 | ✅ 全部已实现 |
| P0优先级 | 6 | ✅ |
| P1优先级 | 8 | ✅ |
| P2优先级 | 8 | ✅ |

---

*文档生成完成*
